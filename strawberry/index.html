<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Strawberry Stand Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        .active-press { transform: scale(0.98); transition: transform 0.1s; }
        
        /* YOUR CUSTOM LOADER */
        .loader {
            color: #ffffff;
            font-size: 45px;
            text-indent: -9999em;
            overflow: hidden;
            width: 1em;
            height: 1em;
            border-radius: 50%;
            position: relative;
            transform: translateZ(0);
            animation: mltShdSpin 1.7s infinite ease, round 1.7s infinite ease;
        }

        @keyframes mltShdSpin {
            0%, 5%, 95%, 100% {
                box-shadow: 0 -0.83em 0 -0.4em, 0 -0.83em 0 -0.42em, 0 -0.83em 0 -0.44em, 0 -0.83em 0 -0.46em, 0 -0.83em 0 -0.477em;
            }
            10%, 59% {
                box-shadow: 0 -0.83em 0 -0.4em, -0.087em -0.825em 0 -0.42em, -0.173em -0.812em 0 -0.44em, -0.256em -0.789em 0 -0.46em, -0.297em -0.775em 0 -0.477em;
            }
            20% {
                box-shadow: 0 -0.83em 0 -0.4em, -0.338em -0.758em 0 -0.42em, -0.555em -0.617em 0 -0.44em, -0.671em -0.488em 0 -0.46em, -0.749em -0.34em 0 -0.477em;
            }
            38% {
                box-shadow: 0 -0.83em 0 -0.4em, -0.377em -0.74em 0 -0.42em, -0.645em -0.522em 0 -0.44em, -0.775em -0.297em 0 -0.46em, -0.82em -0.09em 0 -0.477em;
            }
        }

        @keyframes round {
            0% { transform: rotate(0deg) }
            100% { transform: rotate(360deg) }
        }

        #splash-screen {
            background: #dc2626; /* Red-600 */
            z-index: 999;
            transition: opacity 0.5s ease;
        }

        main { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        #confirm-modal { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans">
    
    <!-- SPLASH SCREEN WITH YOUR LOADER -->
    <div id="splash-screen" class="fixed inset-0 flex flex-col items-center justify-center text-white">
        <div class="loader mb-8">Loading...</div>
        <h1 class="text-2xl font-black italic uppercase tracking-widest mt-4">Connecting to Stand...</h1>
    </div>

    <div id="app" class="max-w-md md:max-w-2xl lg:max-w-4xl mx-auto min-h-screen flex flex-col bg-white shadow-2xl relative">
        
        <header class="bg-red-600 text-white p-4 md:p-6 shadow-lg flex justify-between items-center">
            <div>
                <h1 class="text-xl md:text-2xl font-black italic tracking-tighter uppercase flex items-center gap-2">
                    <i data-lucide="strawberry"></i> Strawberry Sale Terminal
                </h1>
                <div class="flex items-center gap-2 text-[10px] md:text-xs font-bold opacity-90 mt-1">
                    <span id="connection-dot" class="w-2 h-2 rounded-full bg-yellow-400"></span>
                    <span id="connection-text" class="tracking-widest uppercase">Syncing...</span>
                </div>
            </div>
            <div class="flex gap-2 md:gap-4">
                <button onclick="toggleView('history')" class="p-3 bg-red-700 hover:bg-red-800 rounded-xl shadow-inner"><i data-lucide="calendar"></i></button>
                <button onclick="toggleView('settings')" class="p-3 bg-red-700 hover:bg-red-800 rounded-xl shadow-inner"><i data-lucide="settings"></i></button>
            </div>
        </header>

        <!-- REGISTER VIEW -->
        <main id="view-register" class="flex-1 p-4 md:p-8 flex flex-col gap-6">
            <div id="product-grid" class="grid grid-cols-1 md:grid-cols-3 gap-4 py-2"></div>
            <div class="flex-1 flex flex-col border-t-2 border-dashed border-slate-200 mt-4 pt-4 overflow-hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-widest">Live Basket</h3>
                    <button onclick="clearOrder()" class="text-xs font-bold text-red-500 flex items-center gap-1">
                        <i data-lucide="trash-2" class="w-3 h-3"></i> Clear
                    </button>
                </div>
                <div id="cart-items" class="space-y-2 overflow-y-auto max-h-[40vh]"></div>
            </div>
            <div id="checkout-area" class="hidden pb-4">
                <button id="checkout-btn" onclick="processCheckout()" class="w-full bg-green-600 text-white py-6 md:py-8 rounded-3xl shadow-2xl flex justify-between px-8 items-center border-b-8 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
                    <span class="text-3xl md:text-4xl font-black italic uppercase">Done</span>
                    <span id="cart-total" class="text-3xl md:text-4xl font-light">$0.00</span>
                </button>
            </div>
        </main>

        <!-- HISTORY SUMMARY VIEW -->
        <main id="view-history" class="hidden flex-1 p-4 md:p-8 bg-slate-50 overflow-y-auto">
            <div class="flex flex-col gap-6">
                <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-3xl p-6 md:p-10 text-white shadow-2xl relative overflow-hidden">
                    <div class="relative z-10">
                        <div class="flex items-center gap-2 text-blue-400 mb-1">
                            <i data-lucide="crown" class="w-4 h-4 text-yellow-400"></i>
                            <span class="text-[10px] md:text-xs font-black uppercase tracking-widest">Season Earnings</span>
                        </div>
                        <h2 id="season-total" class="text-5xl md:text-6xl font-black tracking-tighter">$0.00</h2>
                        <div id="season-count" class="text-xs font-bold text-slate-400 mt-2 tracking-widest uppercase">0 Sales Total</div>
                    </div>
                </div>

                <!-- SEARCH BOX -->
                <div class="relative">
                    <input type="text" id="history-search" oninput="filterHistory()" placeholder="Search dates (e.g. Oct 12)..." class="w-full pl-12 pr-4 py-4 bg-white border-2 border-slate-200 rounded-2xl font-bold text-slate-800 focus:outline-none focus:border-red-400 transition-all uppercase text-sm tracking-widest">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-5 h-5"></i>
                    <button id="clear-search" onclick="clearSearch()" class="hidden absolute right-4 top-1/2 -translate-y-1/2 text-red-500 font-black text-[10px] uppercase tracking-widest">Clear</button>
                </div>

                <div class="space-y-4">
                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest">Daily Breakdown</h3>
                    <!-- LOADER FOR HISTORY -->
                    <div id="history-loader" class="hidden flex flex-col items-center justify-center p-12">
                        <div class="loader !text-red-600">Loading...</div>
                    </div>
                    <div id="history-content" class="grid grid-cols-1 md:grid-cols-1 gap-4"></div>
                </div>
                <button onclick="toggleView('register')" class="w-full py-5 bg-white border-2 rounded-2xl font-black text-slate-800 uppercase">Back</button>
            </div>
        </main>

        <!-- DAILY DETAIL VIEW -->
        <main id="view-daily-detail" class="hidden flex-1 p-4 md:p-8 bg-slate-50 overflow-y-auto">
            <div class="flex flex-col gap-6">
                <div class="flex items-center justify-between">
                    <button onclick="toggleView('history')" class="flex items-center gap-2 text-slate-500 font-black uppercase text-xs">
                        <i data-lucide="arrow-left" class="w-4 h-4"></i> Back to History
                    </button>
                    <h2 id="detail-date-title" class="text-xl font-black text-slate-800">Date</h2>
                </div>
                <div id="day-detail-content" class="space-y-4"></div>
            </div>
        </main>

        <!-- SETTINGS VIEW -->
        <main id="view-settings" class="hidden flex-1 p-6 md:p-12">
            <div class="max-w-md mx-auto space-y-10">
                <section>
                    <h2 class="text-2xl font-black text-slate-800 mb-4 uppercase">Product List</h2>
                    <div id="product-list-view" class="space-y-4"></div>
                </section>
                
                <section class="pt-8 border-t border-slate-200">
                    <h3 class="text-sm font-black text-red-500 uppercase tracking-widest mb-4 italic">Danger Zone</h3>
                    <div class="bg-red-50 p-6 rounded-3xl border border-red-100">
                        <p class="text-xs text-red-600 font-bold mb-4 italic">Resetting deletes all season sales history.</p>
                        <button onclick="showResetModal()" class="w-full py-4 bg-red-600 text-white rounded-xl font-black shadow-lg active:bg-red-800 transition uppercase tracking-widest text-xs">
                            Reset Season Data
                        </button>
                    </div>
                </section>

                <button onclick="toggleView('register')" class="w-full py-5 bg-slate-800 text-white rounded-2xl font-black uppercase tracking-widest">Return</button>
            </div>
        </main>

        <!-- CONFIRMATION MODAL -->
        <div id="confirm-modal" class="hidden fixed inset-0 z-[100] flex items-center justify-center p-6">
            <div class="bg-white rounded-[40px] p-8 max-w-sm w-full shadow-2xl text-center">
                <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="alert-triangle" class="w-8 h-8"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-900 mb-2 italic uppercase">Are you sure?</h3>
                <p class="text-slate-500 text-sm mb-8">This will permanently delete all records.</p>
                <div class="flex flex-col gap-3">
                    <button onclick="confirmReset()" class="w-full py-4 bg-red-600 text-white rounded-2xl font-black uppercase tracking-widest shadow-lg active:bg-red-800">Yes, Clear All</button>
                    <button onclick="hideResetModal()" class="w-full py-4 bg-slate-100 text-slate-500 rounded-2xl font-black uppercase tracking-widest active:bg-slate-200">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let products = [
            { id: '3pk', name: '3 Pack', price: 10 },
            { id: '6pk', name: '6 Pack', price: 18 },
            { id: 'flat', name: 'Full Flat', price: 35 }
        ];
        let cart = [];
        let fullHistoryData = {}; 
        const API_URL = `https://fast-prawn-humorous.ngrok-free.app`;

        const NGROK_HEADERS = {
            'ngrok-skip-browser-warning': 'true'
        };

        function init() {
            renderRegister();
            renderSettings();
            
            checkStatus().then(() => {
                setTimeout(() => {
                    const splash = document.getElementById('splash-screen');
                    splash.style.opacity = '0';
                    setTimeout(() => splash.remove(), 500);
                }, 1000);
            });

            setInterval(checkStatus, 60000);
            lucide.createIcons();
        }

        async function checkStatus() {
            try {
                const res = await fetch(`${API_URL}/api/history`, { headers: NGROK_HEADERS, signal: AbortSignal.timeout(2000) });
                const isOnline = res.ok;
                document.getElementById('connection-dot').className = isOnline ? "w-2 h-2 rounded-full bg-green-400 shadow-[0_0_8px_rgba(74,222,128,0.8)]" : "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                document.getElementById('connection-text').innerText = isOnline ? "ONLINE" : "OFFLINE";
                return isOnline;
            } catch (e) {
                document.getElementById('connection-dot').className = "w-2 h-2 rounded-full bg-red-500 animate-pulse";
                document.getElementById('connection-text').innerText = "OFFLINE";
                return false;
            }
        }

        function renderRegister() {
            const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            products.forEach(p => {
                grid.innerHTML += `
                    <button onclick="addToCart('${p.id}')" class="bg-white p-8 md:p-10 rounded-3xl border-2 border-slate-100 shadow-sm text-center flex flex-col items-center justify-center transition-all active-press hover:border-red-200">
                        <span class="text-2xl font-black text-slate-800 uppercase tracking-tighter mb-1">${p.name}</span>
                        <span class="text-red-600 font-black text-xl">$${p.price}</span>
                    </button>`;
            });
            lucide.createIcons();
        }

        function renderSettings() {
            const list = document.getElementById('product-list-view');
            list.innerHTML = '';
            products.forEach(p => {
                list.innerHTML += `
                    <div class="flex items-center justify-between p-5 bg-slate-50 border border-slate-100 rounded-3xl">
                        <span class="font-black text-slate-700 text-lg uppercase">${p.name}</span>
                        <span class="font-black text-red-600 text-lg">$${p.price}</span>
                    </div>`;
            });
        }

        function addToCart(id) {
            const p = products.find(x => x.id === id);
            cart.push({...p}); 
            updateCartUI();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartUI();
        }

        function clearOrder() {
            cart = []; 
            updateCartUI();
        }

        function updateCartUI() {
            const list = document.getElementById('cart-items');
            const totalEl = document.getElementById('cart-total');
            const checkout = document.getElementById('checkout-area');
            list.innerHTML = ''; let total = 0;
            cart.forEach((item, i) => {
                total += item.price;
                list.innerHTML += `<div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100"><span class="font-black text-slate-700 uppercase">${item.name}</span><div class="flex items-center gap-4"><span class="font-bold text-red-600">$${item.price}</span><button onclick="removeFromCart(${i})" class="text-slate-300"><i data-lucide="x-circle"></i></button></div></div>`;
            });
            totalEl.innerText = `$${total}`;
            checkout.classList.toggle('hidden', cart.length === 0);
            lucide.createIcons();
        }

        async function processCheckout() {
            const btn = document.getElementById('checkout-btn');
            btn.disabled = true;
            btn.classList.add('opacity-50');

            const total = cart.reduce((s, i) => s + i.price, 0);
            const saleData = { items: cart, total: total };
            try {
                const res = await fetch(`${API_URL}/api/order`, { method: 'POST', headers: { ...NGROK_HEADERS, 'Content-Type': 'application/json' }, body: JSON.stringify(saleData) });
                if (res.ok) { 
                    cart = []; 
                    updateCartUI(); 
                    showToast("SALE SAVED! ðŸ“"); 
                }
            } catch (e) { alert("ERROR: Pi Offline!"); }
            
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        }

        function toggleView(v) {
            ['register', 'history', 'settings', 'daily-detail'].forEach(view => document.getElementById(`view-${view}`).classList.add('hidden'));
            document.getElementById(`view-${v}`).classList.remove('hidden');
            if (v === 'history') {
                document.getElementById('history-search').value = '';
                document.getElementById('clear-search').classList.add('hidden');
                loadHistory();
            }
            lucide.createIcons();
        }

        async function loadHistory() {
            const content = document.getElementById('history-content');
            const loader = document.getElementById('history-loader');
            const seasonTotalEl = document.getElementById('season-total');
            const seasonCountEl = document.getElementById('season-count');
            
            content.innerHTML = '';
            loader.classList.remove('hidden');

            try {
                const res = await fetch(`${API_URL}/api/history`, {
                    headers: NGROK_HEADERS
                });
                const data = await res.json();
                fullHistoryData = data; 
                
                loader.classList.add('hidden');
                let seasonTotal = 0, seasonSales = 0;
                
                Object.keys(data).forEach(date => {
                    data[date].forEach(o => { seasonTotal += o.total; seasonSales++; });
                });

                renderHistoryList(Object.keys(data).reverse());
                
                seasonTotalEl.innerText = `$${seasonTotal}`;
                seasonCountEl.innerText = `${seasonSales} SALES TOTAL`;
            } catch (e) { 
                loader.classList.add('hidden');
                content.innerHTML = '<div class="text-red-500 font-bold p-10 text-center uppercase">History Offline</div>'; 
            }
            lucide.createIcons();
        }

        function filterHistory() {
            const query = document.getElementById('history-search').value.toLowerCase();
            const clearBtn = document.getElementById('clear-search');
            
            if (query.length > 0) clearBtn.classList.remove('hidden');
            else clearBtn.classList.add('hidden');

            const filteredDates = Object.keys(fullHistoryData)
                .reverse()
                .filter(date => date.toLowerCase().includes(query));
            
            renderHistoryList(filteredDates);
        }

        function clearSearch() {
            document.getElementById('history-search').value = '';
            document.getElementById('clear-search').classList.add('hidden');
            filterHistory();
        }

        function renderHistoryList(dates) {
            const content = document.getElementById('history-content');
            content.innerHTML = '';

            if (dates.length === 0) {
                content.innerHTML = '<div class="text-center p-10 text-slate-400 font-bold italic uppercase tracking-widest text-xs">No matching dates found</div>';
                return;
            }

            dates.forEach(date => {
                let dayTotal = fullHistoryData[date].reduce((sum, o) => sum + o.total, 0);
                content.innerHTML += `
                    <button onclick="showDayDetail('${date}')" class="bg-white p-5 rounded-3xl shadow-sm border border-slate-200 flex justify-between items-center text-left active-press">
                        <div>
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${date}</div>
                            <div class="text-lg font-black text-slate-800">${fullHistoryData[date].length} Sales</div>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="text-2xl font-black text-green-600">$${dayTotal}</div>
                            <i data-lucide="chevron-right" class="text-slate-300"></i>
                        </div>
                    </button>`;
            });
            lucide.createIcons();
        }

        function showDayDetail(date) {
            const container = document.getElementById('day-detail-content');
            document.getElementById('detail-date-title').innerText = date;
            container.innerHTML = '';
            
            const orders = fullHistoryData[date];
            orders.slice().reverse().forEach((order, idx) => {
                const itemsSummary = order.items.map(i => i.name).join(", ");
                container.innerHTML += `
                    <div class="bg-white p-5 rounded-3xl border border-slate-100 shadow-sm flex justify-between items-center">
                        <div class="flex-1">
                            <div class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${order.time || 'Sale ' + (orders.length - idx)}</div>
                            <div class="text-slate-700 font-bold text-sm leading-tight uppercase">${itemsSummary}</div>
                        </div>
                        <div class="font-black text-green-600 text-xl ml-4">$${order.total}</div>
                    </div>
                `;
            });
            toggleView('daily-detail');
        }

        function showResetModal() { document.getElementById('confirm-modal').classList.remove('hidden'); lucide.createIcons(); }
        function hideResetModal() { document.getElementById('confirm-modal').classList.add('hidden'); }

        async function confirmReset() {
            try {
                const res = await fetch(`${API_URL}/api/clear`, { method: 'POST', headers: NGROK_HEADERS });
                if (res.ok) { hideResetModal(); showToast("SEASON RESET COMPLETE"); loadHistory(); }
            } catch (e) { alert("Could not reset data."); }
        }

        function showToast(m) {
            const t = document.createElement('div');
            t.className = "fixed top-12 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-10 py-5 rounded-full font-black shadow-2xl z-[200] animate-bounce uppercase tracking-widest text-xs text-center";
            t.innerText = m;
            document.body.appendChild(t);
            setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity 0.5s'; setTimeout(() => t.remove(), 500); }, 2000);
        }

        window.onload = init;
    </script>
</body>
</html>
