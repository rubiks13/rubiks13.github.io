<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon 80mm Route Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        @page {
            size: 80mm auto;
            margin: 0;
        }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            #receipt-container { width: 80mm; margin: 0; padding: 0; }
            #receipt-preview { border: none; box-shadow: none; width: 80mm; padding: 0; }
            .receipt-section { page-break-inside: avoid; border-bottom: 2px dashed black; padding: 8mm 4mm; }
            .receipt-section:last-child { border-bottom: none; }
        }

        #receipt-preview {
            width: 80mm;
            background: white;
            font-family: 'Courier New', Courier, monospace;
            color: black;
            border: 1px solid #ddd;
            margin: 0 auto;
        }

        .receipt-section {
            padding: 8mm 4mm;
            border-bottom: 1px dashed #ccc;
        }

        .receipt-text {
            font-size: 11px;
            line-height: 1.1;
            text-transform: uppercase;
            word-break: break-all;
        }

        .divider {
            border-top: 1px dashed black;
            margin: 4px 0;
        }
        
        .barcode-svg {
            max-width: 100%;
            height: auto;
        }

        .timeout-warning {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            pointer-events: none;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 pb-20">

    <div class="max-w-6xl mx-auto grid lg:grid-cols-2 gap-6">
        <!-- Control Panel -->
        <div class="space-y-6 no-print">
            <!-- Address Manager -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="bg-orange-500 text-white p-1 rounded">üìç</span> Field Address Book
                </h2>
                <div class="flex gap-2 mb-4">
                    <input id="newAddressName" type="text" placeholder="Address Name" class="flex-1 p-2 border rounded">
                    <input id="addressSequence" type="number" placeholder="Order (e.g. 1)" class="w-20 p-2 border rounded">
                    <button onclick="saveAddress()" class="bg-green-600 text-white px-4 py-2 rounded font-bold">+</button>
                </div>
                <div id="addressList" class="space-y-2 max-h-48 overflow-y-auto border-t pt-2">
                    <!-- Addresses show up here -->
                </div>
            </div>

            <!-- Route Controls -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="bg-blue-500 text-white p-1 rounded">üö≤</span> Delivery Route
                </h2>
                <p class="text-sm text-gray-600 mb-4">Generates a random route. Every generated delivery adds $5.00 to your bike bank balance!</p>
                <button id="generateBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                    Generate Optimized Route & Print
                </button>
            </div>
        </div>

        <!-- Preview Panel -->
        <div id="receipt-container" class="flex flex-col items-center">
            <h2 class="text-sm font-bold mb-2 no-print text-gray-500 uppercase tracking-widest">Receipt Preview (80mm)</h2>
            <div id="receipt-preview" class="shadow-xl">
                <div class="p-8 text-center text-gray-400 no-print">
                    Add addresses and click generate to see the route.
                </div>
            </div>
        </div>
    </div>

    <!-- Inactivity Message -->
    <div class="timeout-warning no-print">
        Inactivity redirect in 5s
    </div>

    <script>
        // --- INACTIVITY REDIRECT LOGIC ---
        let idleTimer;
        const idleLimit = 5000; 
        const redirectUrl = "https://rubiks13.github.io/bikes/";

        function resetTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                window.location.href = redirectUrl;
            }, idleLimit);
        }

        window.onload = resetTimer;
        window.onmousemove = resetTimer;
        window.onmousedown = resetTimer; 
        window.ontouchstart = resetTimer;
        window.onclick = resetTimer;     
        window.onkeydown = resetTimer;   

        // --- APP LOGIC ---
        let savedAddresses = JSON.parse(localStorage.getItem('fieldAddresses') || '[]');

        const itemPool = [
            "Reusable Water Bottle", "AA Alkaline Batteries", "USB-C Charging Cable",
            "Screen Cleaning Wipes", "Desktop Organizer", "LED Desk Lamp",
            "Wired Earbuds", "Wireless Mouse", "Graph Paper Notebook",
            "Fine Point Pens", "Reusable Grocery Bag", "Microfiber Cloths",
            "Sticky Note Pad", "Travel Toiletry Kit", "Smartphone Stand"
        ];

        function saveAddress() {
            const name = document.getElementById('newAddressName').value.trim();
            const seq = parseInt(document.getElementById('addressSequence').value) || 0;
            
            if (name) {
                savedAddresses.push({ id: Date.now(), name, seq });
                savedAddresses.sort((a, b) => a.seq - b.seq);
                localStorage.setItem('fieldAddresses', JSON.stringify(savedAddresses));
                renderAddressList();
                document.getElementById('newAddressName').value = '';
                document.getElementById('addressSequence').value = '';
                resetTimer();
            }
        }

        function deleteAddress(id) {
            savedAddresses = savedAddresses.filter(a => a.id !== id);
            localStorage.setItem('fieldAddresses', JSON.stringify(savedAddresses));
            renderAddressList();
            resetTimer();
        }

        function renderAddressList() {
            const container = document.getElementById('addressList');
            container.innerHTML = savedAddresses.length ? '' : '<p class="text-gray-400 text-sm italic">No addresses saved yet.</p>';
            savedAddresses.forEach(addr => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-50 p-2 rounded text-sm border";
                div.innerHTML = `
                    <span><b class="text-orange-600">#${addr.seq}</b> ${addr.name}</span>
                    <button onclick="deleteAddress(${addr.id})" class="text-red-500 font-bold px-2">√ó</button>
                `;
                container.appendChild(div);
            });
        }

        function generateOrderNumber() {
            return `114-${Math.floor(1000000 + Math.random() * 9000000)}-${Math.floor(1000000 + Math.random() * 9000000)}`;
        }

        function generateItems() {
            const count = Math.floor(Math.random() * 4) + 1;
            const shuffled = [...itemPool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count).map(item => `1x ${item}`);
        }

        // Handle Bank Integration
        function processPayment(stopName) {
            let currentBal = parseFloat(localStorage.getItem('sim_bank_balance')) || 0;
            let logs = JSON.parse(localStorage.getItem('sim_bank_logs')) || [];
            
            localStorage.setItem('sim_bank_balance', (currentBal + 5.00).toFixed(2));
            
            logs.unshift({
                type: 'Income',
                amount: 5.00,
                job: `Delivery to ${stopName}`,
                date: new Date().toLocaleString([], {hour: '2-digit', minute:'2-digit'})
            });
            
            localStorage.setItem('sim_bank_logs', JSON.stringify(logs));
        }

        document.getElementById('generateBtn').addEventListener('click', () => {
            if (savedAddresses.length === 0) {
                alert("Please add some addresses first!");
                return;
            }

            const preview = document.getElementById('receipt-preview');
            preview.innerHTML = '';
            
            const maxStops = Math.min(savedAddresses.length, 5);
            const stopCount = Math.floor(Math.random() * maxStops) + 1;
            
            const selectedStops = [...savedAddresses]
                .sort(() => 0.5 - Math.random())
                .slice(0, stopCount)
                .sort((a, b) => a.seq - b.seq);

            const now = new Date().toLocaleString();

            selectedStops.forEach((stop, index) => {
                const orderNum = generateOrderNumber();
                const items = generateItems();
                
                // BANK INTEGRATION CALL
                processPayment(stop.name);

                const section = document.createElement('div');
                section.className = 'receipt-section';
                const barcodeId = `barcode-${index}`;
                
                section.innerHTML = `
                    <div class="text-center mb-2">
                        <h2 class="font-bold text-base">AMAZON</h2>
                        <p class="receipt-text" style="font-size: 9px;">${now}</p>
                        <p class="receipt-text font-bold">STOP ${index + 1} OF ${stopCount}</p>
                    </div>
                    <div class="divider"></div>
                    <div class="my-2">
                        <p class="font-bold receipt-text">ORDER: ${orderNum}</p>
                    </div>
                    <div class="my-2">
                        <p class="font-bold receipt-text underline">SHIP TO:</p>
                        <p class="receipt-text mt-1">${stop.name}</p>
                    </div>
                    <div class="divider"></div>
                    <div class="my-2">
                        <p class="font-bold receipt-text">CONTENTS:</p>
                        <ul class="receipt-text mt-1 space-y-1">
                            ${items.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="divider"></div>
                    <div class="mt-4 flex flex-col items-center">
                        <svg id="${barcodeId}" class="barcode-svg"></svg>
                        <p class="receipt-text mt-2" style="font-size: 8px;">TRACKING: FIELD-DELIVERY-ID-${stop.seq}</p>
                    </div>
                `;
                
                preview.appendChild(section);

                JsBarcode(`#${barcodeId}`, orderNum, {
                    format: "CODE128",
                    width: 1.1,
                    height: 35,
                    displayValue: false,
                    margin: 0
                });
            });

            setTimeout(() => {
                window.print();
                resetTimer();
            }, 500);
        });

        renderAddressList();
    </script>
</body>
</html>
