<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon 80mm Route Generator - Bike Bank v2.7</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        @page {
            size: 80mm auto;
            margin: 0;
        }

        @media print {
            body { background: white; }
            .no-print { display: none !important; }
            #receipt-container { width: 80mm; margin: 0; padding: 0; }
            #receipt-preview { border: none; box-shadow: none; width: 80mm; padding: 0; }
            .receipt-section { page-break-inside: avoid; border-bottom: 2px dashed black; padding: 8mm 4mm; }
            .receipt-section:last-child { border-bottom: none; }
        }

        #receipt-preview {
            width: 80mm;
            background: white;
            font-family: 'Courier New', Courier, monospace;
            color: black;
            border: 1px solid #ddd;
            margin: 0 auto;
        }

        .receipt-section {
            padding: 8mm 4mm;
            border-bottom: 1px dashed #ccc;
        }

        .receipt-text {
            font-size: 11px;
            line-height: 1.1;
            text-transform: uppercase;
            word-break: break-all;
        }

        .divider {
            border-top: 1px dashed black;
            margin: 4px 0;
        }
        
        .barcode-svg {
            max-width: 100%;
            height: auto;
        }

        .timeout-warning {
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            pointer-events: none;
        }

        .deposit-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            z-index: 1000;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 pb-20">

    <div class="max-w-6xl mx-auto grid lg:grid-cols-2 gap-6">
        <!-- Control Panel -->
        <div class="space-y-6 no-print">
            <!-- User Info Card & Bank Link -->
            <div id="userCard" class="bg-blue-600 text-white p-4 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <p class="text-xs opacity-80 uppercase font-bold">Active Driver</p>
                        <h2 id="activeUserName" class="text-xl font-bold">Loading...</h2>
                    </div>
                    <div class="text-right">
                        <p class="text-xs opacity-80 uppercase font-bold">Session Time</p>
                        <p id="bankClock" class="text-lg font-mono">--:--</p>
                    </div>
                </div>
                <button id="goToBankBtn" class="w-full bg-white/20 hover:bg-white/30 border border-white/50 py-2 rounded-lg font-bold transition-all flex items-center justify-center gap-2">
                    üè¶ View Bank Account
                </button>
            </div>

            <!-- Address Manager -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="bg-orange-500 text-white p-1 rounded">üìç</span> Field Address Book
                </h2>
                <div class="flex gap-2 mb-4">
                    <input id="newAddressName" type="text" placeholder="Address Name" class="flex-1 p-2 border rounded">
                    <input id="addressSequence" type="number" placeholder="Order (e.g. 1)" class="w-20 p-2 border rounded">
                    <button onclick="saveAddress()" class="bg-green-600 text-white px-4 py-2 rounded font-bold">+</button>
                </div>
                <div id="addressList" class="space-y-2 max-h-48 overflow-y-auto border-t pt-2"></div>
            </div>

            <!-- Route Controls -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="bg-blue-500 text-white p-1 rounded">üö≤</span> Delivery Route
                </h2>
                <p class="text-sm text-gray-600 mb-4">Each delivery stop adds $5.00 to your personal bike bank account.</p>
                <button id="generateBtn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg transition-colors shadow-md">
                    Generate Optimized Route & Print
                </button>
            </div>
        </div>

        <!-- Preview Panel -->
        <div id="receipt-container" class="flex flex-col items-center">
            <h2 class="text-sm font-bold mb-2 no-print text-gray-500 uppercase tracking-widest">Receipt Preview (80mm)</h2>
            <div id="receipt-preview" class="shadow-xl">
                <div class="p-8 text-center text-gray-400 no-print">
                    Add addresses and click generate to see the route.
                </div>
            </div>
        </div>
    </div>

    <!-- Deposit Link Modal -->
    <div id="modalOverlay" class="modal-overlay hidden no-print"></div>
    <div id="depositModal" class="deposit-modal hidden no-print">
        <div class="text-4xl mb-4">üí∞</div>
        <h3 class="text-xl font-bold mb-2">Earnings Ready!</h3>
        <p class="text-gray-600 mb-6">You earned <span id="modalAmount" class="font-bold text-green-600">$0.00</span> from this delivery run.</p>
        <button id="depositBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition-all mb-3">
            Go to Bank to Deposit
        </button>
        <button onclick="closeModal()" class="text-gray-400 text-sm hover:underline">Close</button>
    </div>

    <div class="timeout-warning no-print">
        Inactivity redirect in 5s
    </div>

    <script>
        // --- v2.7 SYSTEM IDENTITY & USER HAND-OFF ---
        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user') || localStorage.getItem('active_directory_user') || 'Guest';
        document.getElementById('activeUserName').textContent = currentUser;

        // --- BANK REDIRECT LOGIC ---
        document.getElementById('goToBankBtn').onclick = () => {
            window.location.href = `https://rubiks13.github.io/bikes/bank_app.html?user=${encodeURIComponent(currentUser)}`;
        };

        // --- BANK TIME SYNC LOGIC ---
        function getBankTime() {
            let startTime = localStorage.getItem('sim_bank_start_real_time');
            if (!startTime) {
                startTime = Date.now();
                localStorage.setItem('sim_bank_start_real_time', startTime);
            }
            const elapsedMins = (Date.now() - startTime) / 60000;
            const bankHour = Math.floor(elapsedMins % 24);
            const bankMinute = Math.floor((elapsedMins * 60) % 60);
            const ampm = bankHour >= 12 ? 'PM' : 'AM';
            const displayHour = bankHour % 12 || 12;
            const displayMin = bankMinute.toString().padStart(2, '0');
            return `${displayHour}:${displayMin} ${ampm}`;
        }

        // Live clock update
        setInterval(() => {
            document.getElementById('bankClock').textContent = getBankTime();
        }, 1000);

        // --- INACTIVITY REDIRECT LOGIC ---
        let idleTimer;
        const idleLimit = 5000; 
        const redirectUrl = "https://rubiks13.github.io/bikes/";

        function resetTimer() {
            clearTimeout(idleTimer);
            idleTimer = setTimeout(() => {
                window.location.href = redirectUrl;
            }, idleLimit);
        }

        window.onload = resetTimer;
        window.onmousemove = resetTimer;
        window.onmousedown = resetTimer; 
        window.ontouchstart = resetTimer;
        window.onclick = resetTimer;     
        window.onkeydown = resetTimer;   

        // --- MODAL LOGIC ---
        function openModal(amount) {
            document.getElementById('modalAmount').textContent = `$${amount.toFixed(2)}`;
            
            // Updated Deposit URL per user request
            // We'll use "test" for the user and the actual earned amount
            const depositLink = `https://rubiks13.github.io/bank/?user=test&amount=${amount.toFixed(2)}`;
            
            document.getElementById('depositBtn').onclick = () => {
                window.location.href = depositLink;
            };

            document.getElementById('modalOverlay').classList.remove('hidden');
            document.getElementById('depositModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.add('hidden');
            document.getElementById('depositModal').classList.add('hidden');
        }

        // --- APP LOGIC ---
        let savedAddresses = JSON.parse(localStorage.getItem(`fieldAddresses_${currentUser}`) || '[]');

        const itemPool = [
            "Reusable Water Bottle", "AA Alkaline Batteries", "USB-C Charging Cable",
            "Screen Cleaning Wipes", "Desktop Organizer", "LED Desk Lamp",
            "Wired Earbuds", "Wireless Mouse", "Graph Paper Notebook",
            "Fine Point Pens", "Reusable Grocery Bag", "Microfiber Cloths",
            "Sticky Note Pad", "Travel Toiletry Kit", "Smartphone Stand"
        ];

        function saveAddress() {
            const name = document.getElementById('newAddressName').value.trim();
            const seq = parseInt(document.getElementById('addressSequence').value) || 0;
            if (name) {
                savedAddresses.push({ id: Date.now(), name, seq });
                savedAddresses.sort((a, b) => a.seq - b.seq);
                localStorage.setItem(`fieldAddresses_${currentUser}`, JSON.stringify(savedAddresses));
                renderAddressList();
                document.getElementById('newAddressName').value = '';
                document.getElementById('addressSequence').value = '';
                resetTimer();
            }
        }

        function deleteAddress(id) {
            savedAddresses = savedAddresses.filter(a => a.id !== id);
            localStorage.setItem(`fieldAddresses_${currentUser}`, JSON.stringify(savedAddresses));
            renderAddressList();
            resetTimer();
        }

        function renderAddressList() {
            const container = document.getElementById('addressList');
            container.innerHTML = savedAddresses.length ? '' : '<p class="text-gray-400 text-sm italic">No addresses saved yet for this driver.</p>';
            savedAddresses.forEach(addr => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center bg-gray-50 p-2 rounded text-sm border";
                div.innerHTML = `<span><b class="text-orange-600">#${addr.seq}</b> ${addr.name}</span><button onclick="deleteAddress(${addr.id})" class="text-red-500 font-bold px-2">√ó</button>`;
                container.appendChild(div);
            });
        }

        function generateOrderNumber() {
            return `114-${Math.floor(1000000 + Math.random() * 9000000)}-${Math.floor(1000000 + Math.random() * 9000000)}`;
        }

        function generateItems() {
            const count = Math.floor(Math.random() * 4) + 1;
            const shuffled = [...itemPool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count).map(item => `1x ${item}`);
        }

        // v2.7 MANDATORY DATA STORAGE LOGIC
        function processPayment(stopName) {
            const balanceKey = `bank_${currentUser}_balance`;
            const logsKey = `bank_${currentUser}_logs`;

            let currentBal = parseFloat(localStorage.getItem(balanceKey)) || 0;
            let logs = JSON.parse(localStorage.getItem(logsKey)) || [];
            
            localStorage.setItem(balanceKey, (currentBal + 5.00).toFixed(2));
            
            logs.unshift({
                job: `Amazon Delivery: ${stopName}`,
                amount: 5.00,
                bankTime: getBankTime()
            });
            
            localStorage.setItem(logsKey, JSON.stringify(logs));
        }

        document.getElementById('generateBtn').addEventListener('click', () => {
            if (savedAddresses.length === 0) {
                alert("Please add some addresses first!");
                return;
            }

            const preview = document.getElementById('receipt-preview');
            preview.innerHTML = '';
            
            const maxStops = Math.min(savedAddresses.length, 5);
            const stopCount = Math.floor(Math.random() * maxStops) + 1;
            
            const selectedStops = [...savedAddresses]
                .sort(() => 0.5 - Math.random())
                .slice(0, stopCount)
                .sort((a, b) => a.seq - b.seq);

            const now = new Date().toLocaleString();
            let sessionEarnings = stopCount * 5.00;

            selectedStops.forEach((stop, index) => {
                const orderNum = generateOrderNumber();
                const items = generateItems();
                
                // Process local storage storage per v2.7 protocol
                processPayment(stop.name);

                const section = document.createElement('div');
                section.className = 'receipt-section';
                const barcodeId = `barcode-${index}`;
                
                section.innerHTML = `
                    <div class="text-center mb-2">
                        <h2 class="font-bold text-base">AMAZON</h2>
                        <p class="receipt-text" style="font-size: 9px;">${now}</p>
                        <p class="receipt-text font-bold">STOP ${index + 1} OF ${stopCount}</p>
                    </div>
                    <div class="divider"></div>
                    <div class="my-2">
                        <p class="font-bold receipt-text">ORDER: ${orderNum}</p>
                    </div>
                    <div class="my-2">
                        <p class="font-bold receipt-text underline">SHIP TO:</p>
                        <p class="receipt-text mt-1">${stop.name}</p>
                    </div>
                    <div class="divider"></div>
                    <div class="my-2">
                        <p class="font-bold receipt-text">CONTENTS:</p>
                        <ul class="receipt-text mt-1 space-y-1">
                            ${items.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="divider"></div>
                    <div class="mt-4 flex flex-col items-center">
                        <svg id="${barcodeId}" class="barcode-svg"></svg>
                        <p class="receipt-text mt-2" style="font-size: 8px;">TRACKING: ${currentUser.toUpperCase()}-DEL-${stop.seq}</p>
                    </div>
                `;
                
                preview.appendChild(section);

                JsBarcode(`#${barcodeId}`, orderNum, {
                    format: "CODE128",
                    width: 1.1,
                    height: 35,
                    displayValue: false,
                    margin: 0
                });
            });

            setTimeout(() => {
                window.print();
                openModal(sessionEarnings); // Show the Deposit Link button
                resetTimer();
            }, 500);
        });

        renderAddressList();
    </script>
</body>
</html>
