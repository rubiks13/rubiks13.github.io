<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fitness Points Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 480px;
            width: 100%;
        }
        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }
        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            text-align: center;
            color: #1a202c;
            margin-bottom: 1rem;
        }
        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }
        #pointsDisplay {
            font-size: 4rem;
            font-weight: 800;
            color: #3182ce;
            text-align: center;
        }
        .button {
            padding: 0.75rem 1.5rem;
            border-radius: 9999px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }
        .btn-primary {
            background-color: #48bb78;
            color: white;
            border-color: #38a169;
        }
        .btn-primary:hover {
            background-color: #38a169;
        }
        .btn-secondary {
            background-color: #4299e1;
            color: white;
            border-color: #3182ce;
        }
        .btn-secondary:hover {
            background-color: #3182ce;
        }
        .btn-danger {
            background-color: #f56565;
            color: white;
            border-color: #e53e3e;
        }
        .btn-danger:hover {
            background-color: #e53e3e;
        }
        .btn-light {
            background-color: #cbd5e0;
            color: #2d3748;
            border-color: #a0aec0;
        }
        .btn-light:hover {
            background-color: #a0aec0;
        }
        .flex-center {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
        }
        .exercise-list, .reward-list {
            list-style: none;
            padding: 0;
        }
        .exercise-item, .reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .exercise-item:last-child, .reward-item:last-child {
            border-bottom: none;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #4CAF50;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .message-box, .confirm-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.2), 0 10px 10px -5px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-align: center;
            max-width: 90%;
        }
    </style>
</head>
<body>
    <!-- Main Application Container -->
    <div id="app-container" class="container bg-white p-6 rounded-3xl shadow-2xl transition-all duration-300">
        <!-- Main View -->
        <div id="main-view" class="view">
            <h1 class="text-4xl font-extrabold text-gray-800 mb-6">Fitness Points</h1>
            <div class="text-center mb-6">
                <p class="text-xl font-semibold text-gray-600">Total Points</p>
                <p id="totalPointsDisplay" class="text-6xl font-black text-green-500 mt-2">0</p>
            </div>
            <div class="flex-center flex-col sm:flex-row gap-4">
                <button id="startSessionBtn" class="button btn-primary w-full">Start Session</button>
                <button id="rewardsBtn" class="button btn-secondary w-full">Rewards</button>
                <button id="parentLoginBtn" class="button btn-secondary w-full">Parent Zone</button>
            </div>
        </div>

        <!-- Workout Selection View -->
        <div id="workout-selection-view" class="view hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Choose a Workout</h2>
            <div class="flex-center flex-col sm:flex-row gap-4">
                <button id="startCoreBtn" class="button btn-primary w-full">Core Workout</button>
                <button id="startStretchesBtn" class="button btn-secondary w-full">Leg Stretches</button>
            </div>
            <button id="selectionBackBtn" class="button btn-light w-full mt-4">Back</button>
        </div>

        <!-- Session View -->
        <div id="session-view" class="view hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Session</h2>
            <div class="text-center mb-6">
                <p class="text-lg font-medium text-gray-600 mb-2">Current Exercise</p>
                <p id="exerciseName" class="text-3xl font-bold text-blue-600">Jumping Jacks</p>
                <p class="text-lg font-medium text-gray-600 mt-2">
                    Round <span id="currentRoundDisplay">1</span> of <span id="totalRoundsDisplay">3</span>
                </p>
                <p id="pointsPerSecondDisplay" class="text-sm text-gray-500 mt-1 hidden">(1 point per second)</p>
            </div>
            <div class="text-center mb-6">
                <p id="timerDisplay" class="text-6xl font-bold text-red-500">60</p>
            </div>
            <div class="flex-center gap-4">
                <button id="startExerciseBtn" class="button btn-primary">Start</button>
                <button id="nextBtn" class="button btn-primary hidden">Next</button>
                <button id="endSessionBtn" class="button btn-danger">End Session</button>
            </div>
        </div>

        <!-- Rewards View (for children to redeem) -->
        <div id="rewards-view" class="view hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Redeem Rewards</h2>
            <ul id="redeemableRewardList" class="bg-white rounded-xl divide-y divide-gray-200 shadow"></ul>
            <button id="rewardsBackBtn" class="button btn-light w-full mt-4">Back</button>
        </div>

        <!-- Parent Zone View -->
        <div id="parent-zone-view" class="view hidden">
            <h2 class="text-3xl font-bold text-gray-800 text-center mb-4">Parent Zone</h2>
            <div class="flex flex-col gap-4">
                <!-- Sound Toggle -->
                <div class="flex items-center justify-between p-4 bg-gray-100 rounded-xl">
                    <span class="text-lg font-semibold text-gray-800">Timer Sound</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="timerSoundToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>

                <!-- Set Rounds Control -->
                <div class="flex items-center justify-between p-4 bg-gray-100 rounded-xl">
                    <span class="text-lg font-semibold text-gray-800">Set Core Rounds</span>
                    <input type="number" id="roundsInput" min="1" value="3" class="w-24 px-3 py-2 border border-gray-300 rounded-lg text-center font-medium">
                </div>

                <!-- Audio Recorder -->
                <div class="mt-4">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-2">Custom Timer Sound</h3>
                    <div id="audioRecorder" class="bg-gray-100 p-4 rounded-xl mb-4 text-center">
                        <p id="recorderStatus" class="text-sm text-gray-600 mb-2">Ready to record...</p>
                        <div class="flex-center gap-2">
                            <button id="recordBtn" class="button btn-primary w-full">Record</button>
                            <button id="stopBtn" class="button btn-light w-full hidden">Stop</button>
                            <button id="playBtn" class="button btn-secondary w-full hidden">Play</button>
                            <button id="saveBtn" class="button btn-primary w-full hidden">Save</button>
                            <button id="clearAudioBtn" class="button btn-danger w-full hidden">Clear</button>
                        </div>
                    </div>
                </div>

                <!-- Exercise Management -->
                <div class="mt-4">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-2">Manage Exercises</h3>
                    <div id="exerciseForm" class="bg-gray-100 p-4 rounded-xl mb-4">
                        <div class="mb-2">
                            <label for="exerciseNameInput" class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="exerciseNameInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="flex items-center justify-between gap-4">
                            <div class="mb-2 w-full">
                                <label for="durationInput" class="block text-sm font-medium text-gray-700">Duration (seconds)</label>
                                <input type="number" id="durationInput" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="flex items-center gap-2 mb-2">
                                <input type="checkbox" id="manualExerciseToggle" class="rounded text-blue-500 focus:ring-blue-500">
                                <label for="manualExerciseToggle" class="text-sm font-medium text-gray-700">Manual</label>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="pointsInput" class="block text-sm font-medium text-gray-700">Points</label>
                            <input type="number" id="pointsInput" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="flex-center gap-2">
                            <button id="addExerciseBtn" class="button btn-primary w-full">Add Exercise</button>
                            <button id="cancelEditBtn" class="button btn-light hidden">Cancel Edit</button>
                        </div>
                    </div>
                    
                    <ul id="exerciseList" class="bg-white rounded-xl divide-y divide-gray-200 shadow"></ul>
                </div>

                <!-- Reward Management -->
                <div class="mt-4">
                    <h3 class="text-2xl font-semibold text-gray-800 mb-2">Manage Rewards</h3>
                    <div id="rewardForm" class="bg-gray-100 p-4 rounded-xl mb-4">
                        <div class="mb-2">
                            <label for="rewardNameInput" class="block text-sm font-medium text-gray-700">Reward Name</label>
                            <input type="text" id="rewardNameInput" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="mb-2">
                            <label for="rewardPointsInput" class="block text-sm font-medium text-gray-700">Points Cost</label>
                            <input type="number" id="rewardPointsInput" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </div>
                        <div class="flex items-center justify-between gap-4">
                            <div class="mb-4 w-full">
                                <label for="rewardUsesInput" class="block text-sm font-medium text-gray-700">Number of Uses</label>
                                <input type="number" id="rewardUsesInput" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                            </div>
                            <div class="flex items-center gap-2 mb-4">
                                <input type="checkbox" id="unlimitedUsesToggle" class="rounded text-blue-500 focus:ring-blue-500">
                                <label for="unlimitedUsesToggle" class="text-sm font-medium text-gray-700">Unlimited</label>
                            </div>
                        </div>
                        <div class="flex-center gap-2">
                            <button id="addRewardBtn" class="button btn-primary w-full">Add Reward</button>
                            <button id="cancelRewardEditBtn" class="button btn-light hidden">Cancel Edit</button>
                        </div>
                    </div>
                    
                    <ul id="rewardList" class="bg-white rounded-xl divide-y divide-gray-200 shadow"></ul>
                </div>

                <!-- Clear All Data Button -->
                <button id="clearDataBtn" class="button btn-danger w-full mt-4">Clear All Data</button>
                <button id="parentBackBtn" class="button btn-light w-full">Back</button>
            </div>
        </div>
    </div>

    <!-- Message & Confirm Boxes (for no alerts) -->
    <div id="messageBox" class="message-box hidden">
        <p id="messageText" class="text-gray-800 text-lg mb-4"></p>
        <button id="closeMessageBtn" class="button btn-primary">OK</button>
    </div>
    <div id="confirmBox" class="confirm-box hidden">
        <p id="confirmText" class="text-gray-800 text-lg mb-4"></p>
        <div class="flex-center gap-4">
            <button id="confirmYesBtn" class="button btn-primary">Yes</button>
            <button id="confirmNoBtn" class="button btn-light">No</button>
        </div>
    </div>

    <!-- Audio Element for timer end sound -->
    <audio id="timerEndSound" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAAACABAAZGF0YSAAAAAsAAAABwAAADoAAAADgAAAAoAAAAaAAAAIAAAAEAAAABFAAAAoAAAAKAAAAGgAAAA0AAAAMAAAA"></audio>
    <audio id="customAudioPlayer"></audio>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const views = document.querySelectorAll('.view');
            const totalPointsDisplay = document.getElementById('totalPointsDisplay');
            const startSessionBtn = document.getElementById('startSessionBtn');
            const startCoreBtn = document.getElementById('startCoreBtn');
            const startStretchesBtn = document.getElementById('startStretchesBtn');
            const rewardsBtn = document.getElementById('rewardsBtn');
            const parentLoginBtn = document.getElementById('parentLoginBtn');
            const parentBackBtn = document.getElementById('parentBackBtn');
            const rewardsBackBtn = document.getElementById('rewardsBackBtn');
            const selectionBackBtn = document.getElementById('selectionBackBtn');
            const clearDataBtn = document.getElementById('clearDataBtn');
            const sessionView = document.getElementById('session-view');
            const exerciseName = document.getElementById('exerciseName');
            const currentRoundDisplay = document.getElementById('currentRoundDisplay');
            const totalRoundsDisplay = document.getElementById('totalRoundsDisplay');
            const timerDisplay = document.getElementById('timerDisplay');
            const pointsPerSecondDisplay = document.getElementById('pointsPerSecondDisplay');
            const startExerciseBtn = document.getElementById('startExerciseBtn');
            const nextBtn = document.getElementById('nextBtn');
            const endSessionBtn = document.getElementById('endSessionBtn');
            const timerEndSound = document.getElementById('timerEndSound');
            const customAudioPlayer = document.getElementById('customAudioPlayer');
            const timerSoundToggle = document.getElementById('timerSoundToggle');
            const roundsInput = document.getElementById('roundsInput');

            const exerciseNameInput = document.getElementById('exerciseNameInput');
            const durationInput = document.getElementById('durationInput');
            const pointsInput = document.getElementById('pointsInput');
            const addExerciseBtn = document.getElementById('addExerciseBtn');
            const cancelEditBtn = document.getElementById('cancelEditBtn');
            const manualExerciseToggle = document.getElementById('manualExerciseToggle');
            const exerciseList = document.getElementById('exerciseList');

            const rewardNameInput = document.getElementById('rewardNameInput');
            const rewardPointsInput = document.getElementById('rewardPointsInput');
            const rewardUsesInput = document.getElementById('rewardUsesInput');
            const unlimitedUsesToggle = document.getElementById('unlimitedUsesToggle');
            const addRewardBtn = document.getElementById('addRewardBtn');
            const cancelRewardEditBtn = document.getElementById('cancelRewardEditBtn');
            const rewardList = document.getElementById('rewardList');
            const redeemableRewardList = document.getElementById('redeemableRewardList');

            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const closeMessageBtn = document.getElementById('closeMessageBtn');
            const confirmBox = document.getElementById('confirmBox');
            const confirmText = document.getElementById('confirmText');
            const confirmYesBtn = document.getElementById('confirmYesBtn');
            const confirmNoBtn = document.getElementById('confirmNoBtn');

            // New audio recorder elements
            const recorderStatus = document.getElementById('recorderStatus');
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const playBtn = document.getElementById('playBtn');
            const saveBtn = document.getElementById('saveBtn');
            const clearAudioBtn = document.getElementById('clearAudioBtn');

            let totalPoints = 0;
            let currentExercisesSequence = [];
            let timerInterval = null;
            let isTimerSoundEnabled = true;
            let exerciseRounds = 3;
            let editingExerciseIndex = -1; 
            let editingRewardIndex = -1;

            let sessionState = {
                isActive: false,
                typeKey: '',
                currentRound: 1,
                currentExerciseIndex: 0,
                timerSeconds: 0,
                sessionPoints: 0,
                totalRounds: 3 // Default value
            };

            // Define default exercises and rewards
            const defaultExercises = {
                timed: [
                    { name: 'Jumping Jacks', duration: 60, points: 5 },
                    { name: 'Push-ups', duration: 45, points: 5 },
                    { name: 'Squats', duration: 60, points: 5 },
                    { name: 'Sit-ups', duration: 45, points: 5 },
                    { name: 'Plank', duration: 60, points: 5 }
                ],
                stretches: [
                    { name: 'Hamstring Stretch', duration: 180, manual: false },
                    { name: 'Quadriceps Stretch', duration: 180, manual: false }
                ]
            };

            let exercises = defaultExercises;
            let rewards = [];

            // Audio recorder variables
            let mediaRecorder;
            let audioChunks = [];
            const defaultTimerSoundSrc = "data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAAACABAAZGF0YSAAAAAsAAAABwAAADoAAAADgAAAAoAAAAaAAAAIAAAAEAAAABFAAAAoAAAAKAAAAGgAAAA0AAAAMAAAA";

            // --- Core Functions ---
            function renderView(viewId) {
                views.forEach(view => {
                    view.classList.add('hidden');
                });
                document.getElementById(viewId).classList.remove('hidden');
            }

            function showMessageBox(message) {
                messageText.textContent = message;
                messageBox.classList.remove('hidden');
            }

            function showConfirmBox(message) {
                return new Promise((resolve) => {
                    confirmText.textContent = message;
                    confirmBox.classList.remove('hidden');
                    confirmYesBtn.onclick = () => {
                        confirmBox.classList.add('hidden');
                        resolve(true);
                    };
                    confirmNoBtn.onclick = () => {
                        confirmBox.classList.add('hidden');
                        resolve(false);
                    };
                });
            }

            function updatePointsDisplay() {
                totalPointsDisplay.textContent = totalPoints;
                totalPointsDisplay.classList.add('animate-pulse');
                setTimeout(() => totalPointsDisplay.classList.remove('animate-pulse'), 500);
            }

            function saveData() {
                localStorage.setItem('totalPoints', totalPoints.toString());
                localStorage.setItem('isTimerSoundEnabled', isTimerSoundEnabled.toString());
                localStorage.setItem('exerciseRounds', exerciseRounds.toString());
                localStorage.setItem('exercises', JSON.stringify(exercises));
                localStorage.setItem('rewards', JSON.stringify(rewards));
            }

            function loadData() {
                const savedPoints = localStorage.getItem('totalPoints');
                if (savedPoints) {
                    totalPoints = parseInt(savedPoints, 10);
                }
                updatePointsDisplay();

                const savedSound = localStorage.getItem('isTimerSoundEnabled');
                if (savedSound !== null) {
                    isTimerSoundEnabled = savedSound === 'true';
                }

                const savedRounds = localStorage.getItem('exerciseRounds');
                if (savedRounds !== null) {
                    exerciseRounds = parseInt(savedRounds, 10);
                }

                // Load exercises and fall back to defaults if data is missing
                const savedExercises = localStorage.getItem('exercises');
                if (savedExercises) {
                    try {
                        const parsedExercises = JSON.parse(savedExercises);
                        if (parsedExercises.timed) exercises.timed = parsedExercises.timed;
                        if (parsedExercises.stretches) exercises.stretches = parsedExercises.stretches;
                    } catch (e) {
                        console.error("Failed to parse exercises from localStorage, using defaults.");
                        exercises = defaultExercises;
                    }
                }

                const savedRewards = localStorage.getItem('rewards');
                if (savedRewards) {
                    rewards = JSON.parse(savedRewards);
                }

                // Load custom audio if it exists
                const savedAudio = localStorage.getItem('customTimerSound');
                if (savedAudio) {
                    const audioBlob = b64toBlob(savedAudio, 'audio/wav');
                    customAudioPlayer.src = URL.createObjectURL(audioBlob);
                    playBtn.classList.remove('hidden');
                    clearAudioBtn.classList.remove('hidden');
                } else {
                    customAudioPlayer.src = defaultTimerSoundSrc;
                    playBtn.classList.add('hidden');
                    clearAudioBtn.classList.add('hidden');
                }
            }

            function saveSessionProgress() {
                localStorage.setItem('sessionState', JSON.stringify(sessionState));
            }

            function clearSessionProgress() {
                localStorage.removeItem('sessionState');
                sessionState = {
                    isActive: false,
                    typeKey: '',
                    currentRound: 1,
                    currentExerciseIndex: 0,
                    timerSeconds: 0,
                    sessionPoints: 0,
                    totalRounds: 3
                };
            }

            // --- Utility Function to Format Time ---
            function formatTime(seconds) {
                const minutes = Math.floor(seconds / 60);
                const remainingSeconds = seconds % 60;
                const formattedMinutes = String(minutes).padStart(1, '0');
                const formattedSeconds = String(remainingSeconds).padStart(2, '0');
                return `${formattedMinutes}:${formattedSeconds}`;
            }

            // --- Audio Initialization Function ---
            function initializeAudio() {
                 try {
                    timerEndSound.play().then(() => {
                        timerEndSound.pause();
                        timerEndSound.currentTime = 0;
                    }).catch(error => {
                        console.error('Audio playback failed:', error);
                    });
                } catch (error) {
                    console.error('Audio initialization failed:', error);
                }
            }

            // --- Session & Exercise Logic ---
            function startOrResumeTimer() {
                clearInterval(timerInterval);
                const currentExercise = currentExercisesSequence[sessionState.currentExerciseIndex];

                // Check if timerSeconds is 0 to start a new timer, otherwise resume
                if (sessionState.timerSeconds <= 0) {
                    sessionState.timerSeconds = currentExercise.duration;
                }

                nextBtn.textContent = 'Pause';
                nextBtn.classList.remove('hidden');
                startExerciseBtn.classList.add('hidden');

                timerInterval = setInterval(() => {
                    sessionState.timerSeconds--;
                    timerDisplay.textContent = formatTime(sessionState.timerSeconds);
                    if (sessionState.timerSeconds <= 0) {
                        clearInterval(timerInterval);
                        if (isTimerSoundEnabled) {
                            startLoopingAudio();
                        }
                        sessionState.sessionPoints += sessionState.typeKey === 'stretches' ? currentExercise.duration : currentExercise.points;
                        nextBtn.textContent = 'Next';
                        nextBtn.classList.remove('hidden');
                        startExerciseBtn.classList.add('hidden');
                    }
                }, 1000);
            }

            function pauseTimer() {
                clearInterval(timerInterval);
                stopLoopingAudio();
                nextBtn.textContent = 'Resume';
                startExerciseBtn.classList.add('hidden'); // Keep Start hidden when paused
            }

            function startLoopingAudio() {
                if (isTimerSoundEnabled) {
                    customAudioPlayer.loop = true;
                    customAudioPlayer.play().catch(e => console.error("Audio playback error:", e));
                }
            }
            
            function stopLoopingAudio() {
                customAudioPlayer.pause();
                customAudioPlayer.currentTime = 0;
            }

            function loadExercise() {
                if (sessionState.currentRound > sessionState.totalRounds) {
                    endSession();
                    return;
                }
                
                const exercise = currentExercisesSequence[sessionState.currentExerciseIndex];
                exerciseName.textContent = exercise.name;
                currentRoundDisplay.textContent = sessionState.currentRound;
                totalRoundsDisplay.textContent = sessionState.totalRounds;

                if (sessionState.typeKey === 'stretches') {
                    pointsPerSecondDisplay.classList.remove('hidden');
                } else {
                    pointsPerSecondDisplay.classList.add('hidden');
                }
                
                // Set up the UI for the new state
                nextBtn.classList.add('hidden');
                startExerciseBtn.classList.remove('hidden');
                timerDisplay.classList.remove('hidden');
                timerDisplay.textContent = formatTime(exercise.duration);
                

                if (exercise.manual) {
                    timerDisplay.classList.add('hidden');
                    startExerciseBtn.classList.add('hidden');
                    nextBtn.classList.remove('hidden');
                    nextBtn.textContent = 'Done';
                    stopLoopingAudio();
                }
                saveSessionProgress();
            }

            function startSession(typeKey) {
                if (!exercises[typeKey] || exercises[typeKey].length === 0) {
                    showMessageBox('No exercises available. Please add some in the Parent Zone.');
                    return;
                }
                initializeAudio();
                sessionState.isActive = true;
                sessionState.typeKey = typeKey;
                sessionState.currentRound = 1;
                sessionState.currentExerciseIndex = 0;
                sessionState.sessionPoints = 0;
                currentExercisesSequence = exercises[typeKey];
                sessionState.totalRounds = typeKey === 'stretches' ? 3 : exerciseRounds;
                renderView('session-view');
                loadExercise();
            }

            function endSession() {
                clearInterval(timerInterval);
                stopLoopingAudio();
                totalPoints += sessionState.sessionPoints;
                updatePointsDisplay();
                showMessageBox(`Session Complete! You earned ${sessionState.sessionPoints} points.`);
                clearSessionProgress();
                saveData();
                renderView('main-view');
            }

            // --- Audio Recorder Functions ---
            // Helper function to convert Base64 string to a Blob
            function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
                const byteCharacters = atob(b64Data);
                const byteArrays = [];
                for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                    const slice = byteCharacters.slice(offset, offset + sliceSize);
                    const byteNumbers = new Array(slice.length);
                    for (let i = 0; i < slice.length; i++) {
                        byteNumbers[i] = slice.charCodeAt(i);
                    }
                    const byteArray = new Uint8Array(byteNumbers);
                    byteArrays.push(byteArray);
                }
                const blob = new Blob(byteArrays, { type: contentType });
                return blob;
            }

            // Helper function to convert a Blob to a Base64 string
            function blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result.split(',')[1];
                        resolve(base64String);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }

            async function startRecording() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    mediaRecorder.ondataavailable = event => {
                        audioChunks.push(event.data);
                    };
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        customAudioPlayer.src = URL.createObjectURL(audioBlob);
                        playBtn.classList.remove('hidden');
                        saveBtn.classList.remove('hidden');
                        clearAudioBtn.classList.add('hidden');
                        recorderStatus.textContent = 'Recording stopped. Preview or save.';
                    };
                    mediaRecorder.start();
                    recorderStatus.textContent = 'Recording...';
                    recordBtn.classList.add('hidden');
                    stopBtn.classList.remove('hidden');
                    playBtn.classList.add('hidden');
                    saveBtn.classList.add('hidden');
                    clearAudioBtn.classList.add('hidden');
                } catch (err) {
                    recorderStatus.textContent = `Error: ${err.message}. Please allow microphone access.`;
                    console.error('Microphone access denied:', err);
                }
            }

            function stopRecording() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                recordBtn.classList.remove('hidden');
                stopBtn.classList.add('hidden');
            }

            async function saveAudio() {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const base64String = await blobToBase64(audioBlob);
                localStorage.setItem('customTimerSound', base64String);
                recorderStatus.textContent = 'Custom sound saved!';
                saveBtn.classList.add('hidden');
                clearAudioBtn.classList.remove('hidden');
            }

            function clearCustomAudio() {
                localStorage.removeItem('customTimerSound');
                customAudioPlayer.src = defaultTimerSoundSrc;
                recorderStatus.textContent = 'Custom sound cleared.';
                playBtn.classList.add('hidden');
                saveBtn.classList.add('hidden');
                clearAudioBtn.classList.add('hidden');
                recordBtn.classList.remove('hidden');
                
                // Reset audio to the default sound
                customAudioPlayer.src = defaultTimerSoundSrc;
            }

            // --- Exercise Management Functions ---
            function renderExerciseList() {
                exerciseList.innerHTML = '';
                exercises.timed.forEach((exercise, index) => {
                    const durationText = exercise.manual ? '(Manual)' : `${exercise.duration}s`;
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'bg-white', 'rounded-xl', 'mb-2', 'shadow-sm', 'exercise-item');
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${exercise.name}</span>
                            <p class="text-sm text-gray-500">${durationText}, ${exercise.points} pts</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-index="${index}" class="edit-btn text-blue-500 hover:text-blue-700 font-bold">Edit</button>
                            <button data-index="${index}" class="delete-btn text-red-500 hover:text-red-700 font-bold">Delete</button>
                        </div>
                    `;
                    exerciseList.appendChild(li);
                });
            }

            function clearExerciseForm() {
                exerciseNameInput.value = '';
                durationInput.value = '';
                pointsInput.value = '';
                manualExerciseToggle.checked = false;
                durationInput.disabled = false;
                addExerciseBtn.textContent = 'Add Exercise';
                cancelEditBtn.classList.add('hidden');
                editingExerciseIndex = -1;
            }

            function addOrUpdateExercise() {
                const name = exerciseNameInput.value.trim();
                const isManual = manualExerciseToggle.checked;
                let duration = parseInt(durationInput.value, 10);
                const points = parseInt(pointsInput.value, 10);

                if (!name || isNaN(points) || points < 1 || (!isManual && (isNaN(duration) || duration < 1))) {
                    showMessageBox('Please fill out all fields with valid numbers.');
                    return;
                }

                if (isManual) {
                    duration = 0; // Set duration to 0 for manual exercises
                }

                const newExercise = { name, duration, points, manual: isManual };

                if (editingExerciseIndex === -1) {
                    // Add new exercise
                    exercises.timed.push(newExercise);
                    showMessageBox(`Added new exercise: ${name}`);
                } else {
                    // Update existing exercise
                    exercises.timed[editingExerciseIndex] = newExercise;
                    showMessageBox(`Updated exercise: ${name}`);
                }
                
                saveData();
                renderExerciseList();
                clearExerciseForm();
            }

            function deleteExercise(index) {
                exercises.timed.splice(index, 1);
                saveData();
                renderExerciseList();
                showMessageBox('Exercise deleted.');
            }

            function handleExerciseListClick(event) {
                const target = event.target;
                if (target.classList.contains('edit-btn')) {
                    const index = parseInt(target.dataset.index, 10);
                    const exercise = exercises.timed[index];
                    exerciseNameInput.value = exercise.name;
                    pointsInput.value = exercise.points;
                    manualExerciseToggle.checked = exercise.manual || false;
                    durationInput.disabled = exercise.manual;
                    if (!exercise.manual) {
                        durationInput.value = exercise.duration;
                    }
                    addExerciseBtn.textContent = 'Update Exercise';
                    cancelEditBtn.classList.remove('hidden');
                    editingExerciseIndex = index;
                } else if (target.classList.contains('delete-btn')) {
                    const index = parseInt(target.dataset.index, 10);
                    showConfirmBox('Are you sure you want to delete this exercise?').then(confirmed => {
                        if (confirmed) {
                            deleteExercise(index);
                        }
                    });
                }
            }

            // --- Reward Management Functions ---
            function renderRewardList() {
                rewardList.innerHTML = '';
                rewards.forEach((reward, index) => {
                    const usesText = reward.uses === null ? 'Unlimited' : `Uses Left: ${reward.uses}`;
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'bg-white', 'rounded-xl', 'mb-2', 'shadow-sm', 'reward-item');
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${reward.name}</span>
                            <p class="text-sm text-gray-500">${reward.points} pts, ${usesText}</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-index="${index}" class="edit-reward-btn text-blue-500 hover:text-blue-700 font-bold">Edit</button>
                            <button data-index="${index}" class="delete-reward-btn text-red-500 hover:text-red-700 font-bold">Delete</button>
                        </div>
                    `;
                    rewardList.appendChild(li);
                });
            }

            function renderRedeemableRewards() {
                redeemableRewardList.innerHTML = '';
                rewards.forEach((reward, index) => {
                    const usesText = reward.uses === null ? 'Unlimited' : `Uses Left: ${reward.uses}`;
                    const redeemDisabled = totalPoints < reward.points || (reward.uses !== null && reward.uses <= 0);
                    const li = document.createElement('li');
                    li.classList.add('flex', 'justify-between', 'items-center', 'p-4', 'bg-white', 'rounded-xl', 'mb-2', 'shadow-sm', 'reward-item');
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-gray-800">${reward.name}</span>
                            <p class="text-sm text-gray-500">${reward.points} pts, ${usesText}</p>
                        </div>
                        <div class="flex gap-2">
                            <button data-index="${index}" class="redeem-btn button btn-primary ${redeemDisabled ? 'opacity-50 cursor-not-allowed' : ''}" ${redeemDisabled ? 'disabled' : ''}>Redeem</button>
                        </div>
                    `;
                    redeemableRewardList.appendChild(li);
                });
            }

            function clearRewardForm() {
                rewardNameInput.value = '';
                rewardPointsInput.value = '';
                rewardUsesInput.value = '';
                unlimitedUsesToggle.checked = false;
                rewardUsesInput.disabled = false;
                addRewardBtn.textContent = 'Add Reward';
                cancelRewardEditBtn.classList.add('hidden');
                editingRewardIndex = -1;
            }

            function addOrUpdateReward() {
                const name = rewardNameInput.value.trim();
                const points = parseInt(rewardPointsInput.value, 10);
                const isUnlimited = unlimitedUsesToggle.checked;
                let uses = isUnlimited ? null : parseInt(rewardUsesInput.value, 10);

                if (!name || isNaN(points) || points < 1 || (!isUnlimited && (isNaN(uses) || uses < 1))) {
                    showMessageBox('Please fill out all fields with valid numbers.');
                    return;
                }

                const newReward = { name, points, uses };

                if (editingRewardIndex === -1) {
                    rewards.push(newReward);
                    showMessageBox(`Added new reward: ${name}`);
                } else {
                    rewards[editingRewardIndex] = newReward;
                    showMessageBox(`Updated reward: ${name}`);
                }
                saveData();
                renderRewardList();
                renderRedeemableRewards();
                clearRewardForm();
            }
            
            function deleteReward(index) {
                rewards.splice(index, 1);
                saveData();
                renderRewardList();
                renderRedeemableRewards();
                showMessageBox('Reward deleted.');
            }

            function redeemReward(index) {
                const reward = rewards[index];
                if (totalPoints >= reward.points) {
                    if (reward.uses !== null && reward.uses <= 0) {
                        showMessageBox('This reward has no more uses left.');
                        return;
                    }
                    totalPoints -= reward.points;
                    if (reward.uses !== null) {
                        reward.uses--;
                    }
                    updatePointsDisplay();
                    saveData();
                    renderRewardList();
                    renderRedeemableRewards();
                    showMessageBox(`Redeemed ${reward.name}!`);
                } else {
                    showMessageBox('Not enough points to redeem this reward.');
                }
            }

            function handleParentRewardListClick(event) {
                const target = event.target;
                if (target.classList.contains('edit-reward-btn')) {
                    const index = parseInt(target.dataset.index, 10);
                    const reward = rewards[index];
                    rewardNameInput.value = reward.name;
                    rewardPointsInput.value = reward.points;
                    unlimitedUsesToggle.checked = reward.uses === null;
                    rewardUsesInput.disabled = reward.uses === null;
                    if (reward.uses !== null) {
                        rewardUsesInput.value = reward.uses;
                    }
                    addRewardBtn.textContent = 'Update Reward';
                    cancelRewardEditBtn.classList.remove('hidden');
                    editingRewardIndex = index;
                } else if (target.classList.contains('delete-reward-btn')) {
                    const index = parseInt(target.dataset.index, 10);
                    showConfirmBox('Are you sure you want to delete this reward?').then(confirmed => {
                        if (confirmed) {
                            deleteReward(index);
                        }
                    });
                }
            }

            function handleRedeemableRewardListClick(event) {
                const target = event.target;
                if (target.classList.contains('redeem-btn')) {
                    const index = parseInt(target.dataset.index, 10);
                    redeemReward(index);
                }
            }

            // --- Event Listeners ---
            startSessionBtn.onclick = () => {
                renderView('workout-selection-view');
            };

            startCoreBtn.onclick = () => {
                startSession('timed');
            };

            startStretchesBtn.onclick = () => {
                startSession('stretches');
            };

            selectionBackBtn.onclick = () => {
                renderView('main-view');
            };

            rewardsBtn.onclick = () => {
                renderView('rewards-view');
                renderRedeemableRewards();
            };

            rewardsBackBtn.onclick = () => {
                renderView('main-view');
            };

            nextBtn.onclick = () => {
                // Handle Pause/Resume functionality
                if (nextBtn.textContent === 'Pause') {
                    pauseTimer();
                    startExerciseBtn.classList.remove('hidden');
                } else if (nextBtn.textContent === 'Resume') {
                    startOrResumeTimer();
                } else {
                    // This is the "Next" functionality after the timer has ended
                    clearInterval(timerInterval);
                    stopLoopingAudio();
                    const currentExercise = currentExercisesSequence[sessionState.currentExerciseIndex];
                    if (currentExercise.manual) {
                        sessionState.sessionPoints += currentExercise.points;
                    } else if (sessionState.timerSeconds > 0) {
                        if (sessionState.typeKey === 'stretches') {
                            const pointsEarned = currentExercise.duration - sessionState.timerSeconds;
                            sessionState.sessionPoints += pointsEarned;
                        } else {
                            sessionState.sessionPoints += currentExercise.points;
                        }
                    }
                    
                    sessionState.currentExerciseIndex++;
                    if (sessionState.currentExerciseIndex >= currentExercisesSequence.length) {
                        sessionState.currentExerciseIndex = 0;
                        sessionState.currentRound++;
                    }
                    loadExercise();
                }
            };

            startExerciseBtn.onclick = () => {
                startOrResumeTimer();
            };

            endSessionBtn.onclick = () => {
                endSession();
            };

            parentLoginBtn.onclick = () => {
                renderView('parent-zone-view');
                timerSoundToggle.checked = isTimerSoundEnabled;
                roundsInput.value = exerciseRounds;
                renderExerciseList();
                renderRewardList();
                clearExerciseForm();
                clearRewardForm();
            };

            parentBackBtn.onclick = () => {
                renderView('main-view');
            };

            clearDataBtn.onclick = async () => {
                const confirmed = await showConfirmBox('Are you sure you want to clear all data? This cannot be undone.');
                if (confirmed) {
                    localStorage.clear();
                    totalPoints = 0;
                    updatePointsDisplay();
                    isTimerSoundEnabled = true;
                    timerSoundToggle.checked = true;
                    exerciseRounds = 3;
                    roundsInput.value = 3;
                    exercises = JSON.parse(JSON.stringify(defaultExercises));
                    rewards = [];
                    clearSessionProgress();
                    clearCustomAudio();
                    renderExerciseList();
                    renderRewardList();
                    showMessageBox('All data has been cleared.');
                }
            };

            closeMessageBtn.onclick = () => {
                messageBox.classList.add('hidden');
            };

            timerSoundToggle.onchange = () => {
                isTimerSoundEnabled = timerSoundToggle.checked;
                saveData();
                showMessageBox(`Timer sound is now ${isTimerSoundEnabled ? 'on' : 'off'}.`);
            };

            roundsInput.addEventListener('input', () => {
                const newRounds = parseInt(roundsInput.value, 10);
                if (!isNaN(newRounds) && newRounds >= 1) {
                    exerciseRounds = newRounds;
                    saveData();
                }
            });

            manualExerciseToggle.addEventListener('change', () => {
                durationInput.disabled = manualExerciseToggle.checked;
                if (manualExerciseToggle.checked) {
                    durationInput.value = '';
                }
            });

            unlimitedUsesToggle.addEventListener('change', () => {
                rewardUsesInput.disabled = unlimitedUsesToggle.checked;
                if (unlimitedUsesToggle.checked) {
                    rewardUsesInput.value = '';
                }
            });

            addExerciseBtn.onclick = addOrUpdateExercise;
            cancelEditBtn.onclick = clearExerciseForm;
            exerciseList.addEventListener('click', handleExerciseListClick);

            addRewardBtn.onclick = addOrUpdateReward;
            cancelRewardEditBtn.onclick = clearRewardForm;
            rewardList.addEventListener('click', handleParentRewardListClick);
            redeemableRewardList.addEventListener('click', handleRedeemableRewardListClick);

            // New audio recorder event listeners
            recordBtn.onclick = startRecording;
            stopBtn.onclick = stopRecording;
            playBtn.onclick = () => customAudioPlayer.play();
            saveBtn.onclick = saveAudio;
            clearAudioBtn.onclick = clearCustomAudio;

            // --- Initial Load and Session Resume ---
            loadData();
            const savedSessionState = localStorage.getItem('sessionState');
            if (savedSessionState) {
                const parsedState = JSON.parse(savedSessionState);
                if (parsedState.isActive) {
                    sessionState = parsedState;
                    currentExercisesSequence = exercises[sessionState.typeKey];
                    showConfirmBox('A session is in progress. Do you want to resume?').then(resume => {
                        if (resume) {
                            renderView('session-view');
                            loadExercise();
                        } else {
                            clearSessionProgress();
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
