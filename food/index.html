<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Receipt Generator</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a custom font for the receipt */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        /* Custom styles for the 80mm receipt width */
        .receipt-container {
            width: 80mm; /* Standard thermal receipt width */
            background-color: #ffffff;
            color: #000000;
            font-family: 'Roboto Mono', monospace; /* Monospaced font for that thermal look */
            font-size: 10px;
            padding: 10px;
            margin: 20px auto;
            border: 1px dashed #ccc; /* Border to show the edge on screen */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        /* Style for action buttons (Edit/Delete) */
        .action-btn {
            @apply p-1 rounded hover:bg-gray-200 text-gray-500 transition duration-150;
        }

        /* Print-specific styles */
        @media print {
            /* Hide the main UI and only show the receipt */
            #main-ui {
                display: none !important;
            }
            #receipt-output {
                display: block !important;
            }
            body {
                /* Reset margins and padding for printing */
                margin: 0;
                padding: 0;
            }
            .receipt-container {
                /* Ensure no border/shadow appears on the actual printout */
                border: none;
                box-shadow: none;
                width: 80mm;
                margin: 0;
                padding: 0;
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen font-sans">

    <div id="main-ui" class="flex-grow container mx-auto p-4 md:p-8">
        <div class="max-w-xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Custom Receipt Generator</h1>
            <p class="text-gray-600 mb-8">Manage your custom addresses and restaurants below, then click a restaurant button to generate an order!</p>

            <!-- Feedback message (instead of alert) -->
            <div id="error-message" class="hidden text-sm border-2 rounded-lg text-gray-800 border-indigo-400 bg-indigo-100 p-2 text-center mb-6"></div>

            <!-- --- 1. Address Manager Section --- -->
            <div class="mb-8 p-4 bg-indigo-50 rounded-lg border-indigo-200 border">
                <h2 class="text-xl font-semibold text-indigo-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.727A8 8 0 016.343 3.273L4 5h16l-2.343-2.273zM12 18v-6m0 0l-2-2m2 2l2-2" /></svg>
                    1. Delivery Address Manager (Randomly Picked)
                </h2>

                <!-- Input and Save -->
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-address-input" placeholder="Enter a new delivery address" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <button onclick="saveAddress()" class="px-4 py-2 bg-indigo-500 text-white font-medium rounded-lg hover:bg-indigo-600 transition duration-150 shadow-md flex-shrink-0">
                        Save Address
                    </button>
                </div>
                
                <!-- Saved Addresses List -->
                <div id="saved-addresses-list" class="space-y-2 mt-4 max-h-40 overflow-y-auto p-1 bg-white rounded-lg border border-gray-200">
                    <!-- Addresses will be injected here -->
                </div>
            </div>

            <!-- --- 2. Restaurant Manager Section --- -->
            <div class="mb-8 p-4 bg-purple-50 rounded-lg border-purple-200 border">
                <h2 class="text-xl font-semibold text-purple-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-purple-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    2. Custom Restaurant Manager
                </h2>

                <!-- Input and Save -->
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-restaurant-input" placeholder="Enter a custom restaurant name" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                    <button onclick="saveCustomRestaurant()" class="px-4 py-2 bg-purple-500 text-white font-medium rounded-lg hover:bg-purple-600 transition duration-150 shadow-md flex-shrink-0">
                        Save Restaurant
                    </button>
                </div>
                
                <!-- Saved Restaurants List -->
                <div id="custom-restaurants-list" class="space-y-2 mt-4 max-h-40 overflow-y-auto p-1 bg-white rounded-lg border border-gray-200">
                    <!-- Custom restaurants will be injected here -->
                </div>
            </div>

            <!-- --- 3. Restaurant Selector Section --- -->
            <div id="options-container" class="space-y-4">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                    3. Click to Order (Uses Saved Restaurants):
                </h2>
                <!-- Restaurant buttons will be injected here -->
            </div>
        </div>
    </div>

    <!-- The receipt area - Hidden by default, only shown on print -->
    <div id="receipt-output" class="hidden">
        <div id="receipt-content" class="receipt-container">
            <!-- Receipt HTML will be injected here -->
        </div>
    </div>

    <script>
        // --- 4. Return to Home Logic ---
        let inactivityTimeout;
        const REDIRECT_URL = "https://rubiks13.github.io/bikes/";
        const INACTIVITY_LIMIT = 5000; // 5 seconds

        function resetInactivityTimer() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                window.location.href = REDIRECT_URL;
            }, INACTIVITY_LIMIT);
        }

        // Event listeners for activity
        window.addEventListener('mousemove', resetInactivityTimer);
        window.addEventListener('keydown', resetInactivityTimer);
        window.addEventListener('scroll', resetInactivityTimer);
        window.addEventListener('mousedown', resetInactivityTimer);
        window.addEventListener('touchstart', resetInactivityTimer);

        // Start timer on load
        resetInactivityTimer();

        // Default (seed) restaurant names and items (used if custom lists are empty)
        const defaultFastFoodNames = [
            "Burger Blast", "Taco Titan", "Waffle Wizard", "Pizza Portal"
        ];
        
        const menuItems = [
            { name: "Super Burger Deluxe", price: 12.99 },
            { name: "Crispy Chicken Sandwich", price: 9.50 },
            { name: "Loaded Chili Cheese Fries", price: 6.75 },
            { name: "Milkshake (Vanilla)", price: 4.50 },
            { name: "Jumbo Soft Taco", price: 3.25 },
            { name: "Large Soda", price: 2.50 },
            { name: "Spicy Wing Basket", price: 11.25 },
            { name: "Onion Rings", price: 5.00 },
            { name: "Chocolate Chip Cookie", price: 1.50 },
            { name: "Water Bottle", price: 1.00 },
        ];

        // Local Storage Keys
        const ADDRESS_KEY = 'savedAddresses';
        const RESTAURANT_KEY = 'customRestaurants';
        
        // State variables
        let addresses = [];
        let customRestaurants = [];

        // --- Helper Functions ---
        const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const getRandomFloat = (min, max) => (Math.random() * (max - min) + min).toFixed(2);
        const getRandomInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;
        
        function showTemporaryMessage(message, className) {
            const messageBox = document.getElementById('error-message');
            messageBox.textContent = message;
            messageBox.className = `mt-4 p-3 border-2 rounded-lg font-medium text-center transition duration-300 ${className}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }

        // --- Local Storage Sync ---

        function saveStateToLocalStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                console.error(`Error saving ${key} to local storage:`, e);
            }
        }

        function loadStateFromLocalStorage(key) {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : [];
            } catch (e) {
                return [];
            }
        }

        // --- Address Management ---

        function loadAddresses() {
            addresses = loadStateFromLocalStorage(ADDRESS_KEY);
            if (addresses.length === 0) {
                 addresses.push({
                    id: Date.now().toString() + Math.random(), 
                    text: "100 Fictional Rd, Test City, USA", 
                    isEditing: false
                 });
                 saveStateToLocalStorage(ADDRESS_KEY, addresses);
            }
            renderAddressOptions();
        }

        window.saveAddress = function(editId) {
            const input = document.getElementById(editId ? `address-input-${editId}` : 'new-address-input');
            const addressText = input.value.trim();
            if (!addressText) return;

            if (editId) {
                const index = addresses.findIndex(a => a.id === editId);
                if (index > -1) {
                    addresses[index].text = addressText;
                    addresses[index].isEditing = false;
                    saveStateToLocalStorage(ADDRESS_KEY, addresses);
                }
            } else {
                addresses.push({ id: Date.now().toString(), text: addressText, isEditing: false });
                saveStateToLocalStorage(ADDRESS_KEY, addresses);
            }
            if (!editId) input.value = '';
            renderAddressOptions();
        }

        window.deleteAddress = function(id) {
            addresses = addresses.filter(a => a.id !== id);
            saveStateToLocalStorage(ADDRESS_KEY, addresses);
            renderAddressOptions();
        }

        window.startEditAddress = function(id) {
            addresses = addresses.map(a => ({ ...a, isEditing: a.id === id }));
            renderAddressOptions();
        }

        window.cancelEditAddress = function() {
             addresses = addresses.map(a => ({ ...a, isEditing: false }));
             renderAddressOptions();
        }

        function renderAddressOptions() {
            const container = document.getElementById('saved-addresses-list');
            container.innerHTML = '';
            addresses.forEach(addr => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 border-b border-gray-100 last:border-b-0";
                if (addr.isEditing) {
                    div.innerHTML = `<input type="text" id="address-input-${addr.id}" value="${addr.text}" class="flex-grow p-1 text-sm border rounded mr-2"><button onclick="saveAddress('${addr.id}')" class="px-2 py-1 bg-green-500 text-white text-xs rounded mr-1">Save</button><button onclick="cancelEditAddress()" class="px-2 py-1 bg-gray-400 text-white text-xs rounded">Cancel</button>`;
                } else {
                    div.innerHTML = `<span class="text-sm text-gray-800 truncate">${addr.text}</span><div class="flex space-x-1"><button onclick="startEditAddress('${addr.id}')" class="action-btn">Edit</button><button onclick="deleteAddress('${addr.id}')" class="action-btn">Del</button></div>`;
                }
                container.appendChild(div);
            });
        }

        // --- Restaurant Management ---

        function loadCustomRestaurants() {
            customRestaurants = loadStateFromLocalStorage(RESTAURANT_KEY);
            if (customRestaurants.length === 0) {
                 defaultFastFoodNames.forEach(name => {
                    customRestaurants.push({ id: Date.now().toString() + Math.random(), name: name, isEditing: false });
                 });
                 saveStateToLocalStorage(RESTAURANT_KEY, customRestaurants);
            }
            renderCustomRestaurantOptions();
            generateNameOptions();
        }

        window.saveCustomRestaurant = function(editId) {
            const input = document.getElementById(editId ? `restaurant-input-${editId}` : 'new-restaurant-input');
            const nameText = input.value.trim();
            if (!nameText) return;

            if (editId) {
                const index = customRestaurants.findIndex(r => r.id === editId);
                if (index > -1) {
                    customRestaurants[index].name = nameText;
                    customRestaurants[index].isEditing = false;
                    saveStateToLocalStorage(RESTAURANT_KEY, customRestaurants);
                }
            } else {
                customRestaurants.push({ id: Date.now().toString(), name: nameText, isEditing: false });
                saveStateToLocalStorage(RESTAURANT_KEY, customRestaurants);
            }
            if (!editId) input.value = '';
            renderCustomRestaurantOptions();
            generateNameOptions();
        }

        window.deleteRestaurant = function(id) {
            customRestaurants = customRestaurants.filter(r => r.id !== id);
            saveStateToLocalStorage(RESTAURANT_KEY, customRestaurants);
            renderCustomRestaurantOptions();
            generateNameOptions();
        }

        window.startEditRestaurant = function(id) {
            customRestaurants = customRestaurants.map(r => ({ ...r, isEditing: r.id === id }));
            renderCustomRestaurantOptions();
        }
        
        window.cancelEditRestaurant = function() {
             customRestaurants = customRestaurants.map(r => ({ ...r, isEditing: false }));
             renderCustomRestaurantOptions();
        }

        function renderCustomRestaurantOptions() {
            const container = document.getElementById('custom-restaurants-list');
            container.innerHTML = '';
            customRestaurants.forEach(res => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 border-b border-gray-100 last:border-b-0";
                if (res.isEditing) {
                    div.innerHTML = `<input type="text" id="restaurant-input-${res.id}" value="${res.name}" class="flex-grow p-1 text-sm border rounded mr-2"><button onclick="saveCustomRestaurant('${res.id}')" class="px-2 py-1 bg-green-500 text-white text-xs rounded mr-1">Save</button><button onclick="cancelEditRestaurant()" class="px-2 py-1 bg-gray-400 text-white text-xs rounded">Cancel</button>`;
                } else {
                    div.innerHTML = `<span class="text-sm text-gray-800 truncate">${res.name}</span><div class="flex space-x-1"><button onclick="startEditRestaurant('${res.id}')" class="action-btn">Edit</button><button onclick="deleteRestaurant('${res.id}')" class="action-btn">Del</button></div>`;
                }
                container.appendChild(div);
            });
        }

        window.generateNameOptions = function() {
            const container = document.getElementById('options-container');
            let currentButton = container.lastElementChild;
            while (currentButton && currentButton.tagName === 'BUTTON') {
                currentButton.remove();
                currentButton = container.lastElementChild;
            }
            customRestaurants.forEach(restaurant => {
                const button = document.createElement('button');
                button.textContent = restaurant.name;
                button.className = "w-full py-4 px-4 text-white font-bold bg-indigo-500 rounded-lg shadow-lg hover:bg-indigo-600 active:translate-y-0.5 transition duration-150 transform tracking-wider text-lg";
                button.onclick = () => handleSelection(restaurant.name);
                container.appendChild(button);
            });
        }

        function generateReceipt(restaurantName, deliveryAddress) {
            const taxRate = 0.0825;
            let subtotal = 0;
            const numItemTypes = getRandomInt(1, 3);
            const menuCopy = [...menuItems]; 
            for (let i = 0; i < numItemTypes; i++) {
                const itemIndex = getRandomInt(0, menuCopy.length - 1);
                const item = menuCopy.splice(itemIndex, 1)[0] || menuItems[i % menuItems.length]; 
                const quantity = getRandomInt(1, 2);
                subtotal += (item.price * quantity);
            }
            const total = subtotal + (subtotal * taxRate) + 2.50 + 3.00; // Simplified fees
            const divider = "----------------------------------------";
            return `
                <div style="text-align: center; margin-bottom: 10px;"><span style="font-size: 14px; font-weight: bold;">U B E R &nbsp; E A T S</span></div>
                <div style="text-align: center; margin: 15px 0; padding: 5px; border-bottom: 1px dashed black; border-top: 1px dashed black;">
                    <p style="font-size: 16px; font-weight: bold;">DELIVERY TO:</p>
                    <p style="font-size: 18px; font-weight: 700;">${deliveryAddress.toUpperCase()}</p>
                </div>
                <p>${divider}</p>
                <div style="text-align: center; font-size: 16px; font-weight: bold; margin-bottom: 15px;">${restaurantName.toUpperCase()}</div>
                <p>${divider}</p>
                <div style="font-size: 13px; font-weight: bold; margin: 15px 0;"><div style="display: flex; justify-content: space-between;"><span>TOTAL CHARGED</span><span>$${total.toFixed(2)}</span></div></div>
                <p>${divider}</p>
                <div style="text-align: center; font-size: 9px; margin-top: 10px;"><p>Order processed through Uber Eats Platform.</p></div>
            `;
        }

        /**
         * Updated Job Completion logic with Bank Integration
         */
        function handleSelection(restaurantName) {
            if (addresses.length === 0) {
                 showTemporaryMessage("Error: You must save at least one delivery address first.", 'text-red-800 border-red-400 bg-red-100');
                 return;
            }

            // 1. Bank Integration Logic
            let currentBal = parseFloat(localStorage.getItem('sim_bank_balance')) || 0;
            let logs = JSON.parse(localStorage.getItem('sim_bank_logs')) || [];
            
            localStorage.setItem('sim_bank_balance', (currentBal + 5.00).toFixed(2));
            
            logs.unshift({
                type: 'Income',
                amount: 5.00,
                job: restaurantName, // Insert actual job name here
                date: new Date().toLocaleString([], {hour: '2-digit', minute:'2-digit'})
            });
            
            localStorage.setItem('sim_bank_logs', JSON.stringify(logs));

            // 2. Original Receipt Generation Logic
            const randomAddress = getRandomElement(addresses);
            const receiptHTML = generateReceipt(restaurantName, randomAddress.text);
            document.getElementById('receipt-content').innerHTML = receiptHTML;
            
            showTemporaryMessage(`Success! $5.00 added to your bank for the ${restaurantName} order.`, 'text-green-800 border-green-400 bg-green-100');
            
            window.print();
        }

        window.onload = function() {
            loadAddresses();
            loadCustomRestaurants();
        };
    </script>
</body>
</html>
