<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Custom Receipt Generator</title>
    <!-- Load Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define a custom font for the receipt */
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        /* Custom styles for the 80mm receipt width */
        .receipt-container {
            width: 80mm;
            background-color: #ffffff;
            color: #000000;
            font-family: 'Roboto Mono', monospace;
            font-size: 10px;
            padding: 10px;
            margin: 20px auto;
            border: 1px dashed #ccc;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        
        /* Style for action buttons (Edit/Delete) */
        .action-btn {
            @apply p-1 rounded hover:bg-gray-200 text-gray-500 transition duration-150;
        }

        /* Animation for the success modal */
        @keyframes bounce-short {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        .animate-bounce-short {
            animation: bounce-short 0.5s ease-in-out 1;
        }

        /* Print-specific styles */
        @media print {
            #main-ui { display: none !important; }
            #receipt-output { display: block !important; }
            body { margin: 0; padding: 0; }
            .receipt-container { border: none; box-shadow: none; width: 80mm; margin: 0; padding: 0; }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen font-sans">

    <div id="main-ui" class="flex-grow container mx-auto p-4 md:p-8">
        <!-- Top Navigation -->
        <div class="max-w-xl mx-auto mb-4 flex justify-between items-center px-2">
            <span id="user-display" class="text-xs font-bold text-gray-400 uppercase tracking-widest">User: Loading...</span>
            <a id="bank-link" href="#" class="text-xs font-bold text-indigo-600 hover:underline uppercase tracking-widest">Open Bank â†’</a>
        </div>

        <div class="max-w-xl mx-auto bg-white p-6 md:p-10 rounded-xl shadow-2xl">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Receipt Generator</h1>
            <p class="text-gray-600 mb-8">Click a restaurant to generate an order and earn $5.00 for your account.</p>

            <!-- Feedback message -->
            <div id="error-message" class="hidden text-sm border-2 rounded-lg text-gray-800 border-indigo-400 bg-indigo-100 p-2 text-center mb-6"></div>

            <!-- Address Manager -->
            <div class="mb-8 p-4 bg-indigo-50 rounded-lg border-indigo-200 border">
                <h2 class="text-lg font-semibold text-indigo-700 mb-4 flex items-center">
                    Delivery Addresses
                </h2>
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-address-input" placeholder="Enter address" class="flex-grow p-2 border border-gray-300 rounded-lg text-sm">
                    <button onclick="saveAddress()" class="px-4 py-2 bg-indigo-500 text-white font-medium rounded-lg text-sm transition hover:bg-indigo-600">Save</button>
                </div>
                <div id="saved-addresses-list" class="space-y-2 mt-4 max-h-40 overflow-y-auto p-1 bg-white rounded-lg border border-gray-200"></div>
            </div>

            <!-- Restaurant Manager -->
            <div class="mb-8 p-4 bg-purple-50 rounded-lg border-purple-200 border">
                <h2 class="text-lg font-semibold text-purple-700 mb-4">Restaurants</h2>
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="new-restaurant-input" placeholder="Restaurant name" class="flex-grow p-2 border border-gray-300 rounded-lg text-sm">
                    <button onclick="saveCustomRestaurant()" class="px-4 py-2 bg-purple-500 text-white font-medium rounded-lg text-sm transition hover:bg-purple-600">Add</button>
                </div>
                <div id="custom-restaurants-list" class="space-y-2 mt-4 max-h-40 overflow-y-auto p-1 bg-white rounded-lg border border-gray-200"></div>
            </div>

            <!-- Action Section -->
            <div id="options-container" class="space-y-4">
                <h2 class="text-xl font-semibold text-indigo-600 mb-4">Select Order:</h2>
            </div>
        </div>
    </div>

    <!-- The receipt area -->
    <div id="receipt-output" class="hidden">
        <div id="receipt-content" class="receipt-container"></div>
    </div>

    <script>
        // --- Identity & Protocol Initialization ---
        const urlParams = new URLSearchParams(window.location.search);
        const ACTIVE_USER = urlParams.get('user') || localStorage.getItem('active_directory_user') || 'guest';
        
        // Storage Keys - Account Specific
        const BAL_KEY = `bank_${ACTIVE_USER}_balance`;
        const LOG_KEY = `bank_${ACTIVE_USER}_logs`;
        const ADDR_KEY = `receipt_${ACTIVE_USER}_addresses`; 
        const REST_KEY = `receipt_${ACTIVE_USER}_restaurants`;

        // Update UI Identity and Base Bank Link
        document.getElementById('user-display').textContent = `User: ${ACTIVE_USER}`;
        document.getElementById('bank-link').href = `https://rubiks13.github.io/bank/?user=${ACTIVE_USER}`;

        // --- Bank Time Synchronization ---
        function getBankTime() {
            let startTime = localStorage.getItem('sim_bank_start_real_time');
            if (!startTime) {
                startTime = Date.now();
                localStorage.setItem('sim_bank_start_real_time', startTime);
            }
            const elapsedMins = (Date.now() - startTime) / 60000;
            const bankHour = Math.floor(elapsedMins % 24);
            const bankMinute = Math.floor((elapsedMins * 60) % 60);
            const ampm = bankHour >= 12 ? 'PM' : 'AM';
            const displayHour = bankHour % 12 || 12;
            const displayMin = bankMinute.toString().padStart(2, '0');
            return `${displayHour}:${displayMin} ${ampm}`;
        }

        // --- Security Protocol: Inactivity Redirect ---
        let inactivityTimeout;
        const REDIRECT_URL = "https://rubiks13.github.io/bikes/";
        const INACTIVITY_LIMIT = 5000; // 5 seconds

        function resetInactivityTimer() {
            clearTimeout(inactivityTimeout);
            inactivityTimeout = setTimeout(() => {
                window.location.href = REDIRECT_URL;
            }, INACTIVITY_LIMIT);
        }

        ['mousemove', 'keydown', 'scroll', 'mousedown', 'touchstart'].forEach(evt => {
            window.addEventListener(evt, resetInactivityTimer);
        });
        resetInactivityTimer();

        // --- State Management ---
        let addresses = [];
        let customRestaurants = [];

        function saveState(key, data) { localStorage.setItem(key, JSON.stringify(data)); }
        function loadState(key) { return JSON.parse(localStorage.getItem(key)) || []; }

        function initApp() {
            addresses = loadState(ADDR_KEY);
            if (addresses.length === 0) {
                 addresses.push({ id: 'def', text: "123 Main St, Central City", isEditing: false });
                 saveState(ADDR_KEY, addresses);
            }
            
            customRestaurants = loadState(REST_KEY);
            if (customRestaurants.length === 0) {
                ["Burger Hub", "Pizza Express", "Taco Town"].forEach(n => customRestaurants.push({ id: Math.random().toString(), name: n, isEditing: false }));
                saveState(REST_KEY, customRestaurants);
            }
            renderAddresses();
            renderRestaurants();
            renderButtons();
        }

        function renderAddresses() {
            const list = document.getElementById('saved-addresses-list');
            list.innerHTML = '';
            addresses.forEach(addr => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 border-b text-sm";
                div.innerHTML = addr.isEditing ? 
                    `<input type="text" id="address-input-${addr.id}" value="${addr.text}" class="flex-grow p-1 border rounded mr-2"><button onclick="saveAddress('${addr.id}')" class="text-green-600 font-bold">Save</button>` :
                    `<span class="truncate pr-2">${addr.text}</span><div class="flex space-x-2"><button onclick="startEditAddress('${addr.id}')" class="text-blue-500">Edit</button><button onclick="deleteAddress('${addr.id}')" class="text-red-500">X</button></div>`;
                list.appendChild(div);
            });
        }

        window.saveAddress = function(id) {
            const input = document.getElementById(id ? `address-input-${id}` : 'new-address-input');
            const val = input.value.trim();
            if (!val) return;
            if (id) {
                const idx = addresses.findIndex(a => a.id === id);
                addresses[idx].text = val;
                addresses[idx].isEditing = false;
            } else {
                addresses.push({ id: Date.now().toString(), text: val, isEditing: false });
                input.value = '';
            }
            saveState(ADDR_KEY, addresses);
            renderAddresses();
        };

        window.deleteAddress = function(id) {
            addresses = addresses.filter(a => a.id !== id);
            saveState(ADDR_KEY, addresses);
            renderAddresses();
        };

        window.startEditAddress = id => { addresses = addresses.map(a => ({ ...a, isEditing: a.id === id })); renderAddresses(); };

        window.saveCustomRestaurant = function(id) {
            const input = document.getElementById(id ? `res-input-${id}` : 'new-restaurant-input');
            const val = input.value.trim();
            if (!val) return;
            if (id) {
                const idx = customRestaurants.findIndex(r => r.id === id);
                customRestaurants[idx].name = val;
                customRestaurants[idx].isEditing = false;
            } else {
                customRestaurants.push({ id: Date.now().toString(), name: val, isEditing: false });
                input.value = '';
            }
            saveState(REST_KEY, customRestaurants);
            renderRestaurants();
            renderButtons();
        };

        function renderRestaurants() {
            const list = document.getElementById('custom-restaurants-list');
            list.innerHTML = '';
            customRestaurants.forEach(res => {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-2 border-b text-sm";
                div.innerHTML = `<span class="truncate">${res.name}</span><button onclick="deleteRestaurant('${res.id}')" class="text-red-400">Remove</button>`;
                list.appendChild(div);
            });
        }

        window.deleteRestaurant = id => { customRestaurants = customRestaurants.filter(r => r.id !== id); saveState(REST_KEY, customRestaurants); renderRestaurants(); renderButtons(); };

        function renderButtons() {
            const container = document.getElementById('options-container');
            [...container.querySelectorAll('button')].forEach(b => b.remove());
            customRestaurants.forEach(r => {
                const btn = document.createElement('button');
                btn.textContent = `Order from ${r.name}`;
                btn.className = "w-full py-4 px-4 text-white font-bold bg-indigo-500 rounded-lg shadow-lg hover:bg-indigo-600 transition transform active:scale-95";
                btn.onclick = () => handleSelection(r.name);
                container.appendChild(btn);
            });
        }

        // --- Core Application Logic ---
        function generateReceipt(restaurantName, deliveryAddress) {
            const total = (Math.random() * 30 + 15).toFixed(2);
            return `
                <div style="text-align: center; margin-bottom: 10px;"><span style="font-size: 14px; font-weight: bold;">U B E R &nbsp; E A T S</span></div>
                <div style="text-align: center; margin: 15px 0; padding: 5px; border-bottom: 1px dashed black; border-top: 1px dashed black;">
                    <p style="font-size: 14px; font-weight: bold;">DELIVERY TO:</p>
                    <p style="font-size: 16px; font-weight: 700;">${deliveryAddress.toUpperCase()}</p>
                </div>
                <p>----------------------------------------</p>
                <div style="text-align: center; font-size: 15px; font-weight: bold; margin-bottom: 15px;">${restaurantName.toUpperCase()}</div>
                <p>----------------------------------------</p>
                <div style="font-size: 13px; font-weight: bold; margin: 15px 0;"><div style="display: flex; justify-content: space-between;"><span>TOTAL CHARGED</span><span>$${total}</span></div></div>
                <p>----------------------------------------</p>
                <div style="text-align: center; font-size: 9px; margin-top: 10px;"><p>Order processed through Uber Eats Platform.</p></div>
            `;
        }

        function handleSelection(restaurantName) {
            if (addresses.length === 0) return;

            const addr = addresses[Math.floor(Math.random() * addresses.length)].text;
            document.getElementById('receipt-content').innerHTML = generateReceipt(restaurantName, addr);
            window.print();

            setTimeout(() => {
                // Game parameters
                const amount = 5.00;
                const missionName = "Uber Delivery";
                const txid = Date.now();
                
                // 1. Update Local Storage Persistence
                let currentBal = parseFloat(localStorage.getItem(BAL_KEY)) || 0;
                let logs = JSON.parse(localStorage.getItem(LOG_KEY)) || [];

                localStorage.setItem(BAL_KEY, (currentBal + amount).toFixed(2));
                logs.unshift({
                    job: `${missionName}: ${restaurantName}`,
                    amount: amount,
                    bankTime: getBankTime(),
                    txid: txid
                });
                localStorage.setItem(LOG_KEY, JSON.stringify(logs));

                // 2. Generate the Dynamic Deposit Link
                // Pattern: https://rubiks13.github.io/bank/?user=[NAME]&deposit=[AMOUNT]&label=[MISSION_NAME]&txid=[UNIQUE_ID]
                const depositUrl = `https://rubiks13.github.io/bank/?user=${encodeURIComponent(ACTIVE_USER)}&deposit=${amount.toFixed(2)}&label=${encodeURIComponent(missionName)}&txid=${txid}`;

                // 3. Show Success Notification with 'Go to Bank' Button
                const alert = document.createElement('div');
                alert.className = "fixed inset-0 flex items-center justify-center z-[10000] bg-black bg-opacity-50 p-4";
                alert.innerHTML = `
                    <div class="bg-white rounded-2xl p-6 text-center shadow-2xl max-w-sm w-full transform transition-all animate-bounce-short">
                        <div class="text-4xl mb-4">ðŸ’°</div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">$${amount.toFixed(2)} Earned!</h3>
                        <p class="text-gray-600 mb-6 text-sm">Order for ${restaurantName} processed successfully.</p>
                        <div class="flex flex-col space-y-2">
                            <a href="${depositUrl}" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition duration-200">
                                Go to Bank & Deposit
                            </a>
                            <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-600 text-sm font-medium py-2">
                                Stay on Page
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(alert);
            }, 500);
        }

        window.onload = initApp;
    </script>
</body>
</html>
