<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fly USA Boarding Pass Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Libre+Barcode+128&family=JetBrains+Mono:wght@400;700&display=swap');

        :root {
            --printer-width: 75mm;
            --glass-blue: rgba(15, 23, 42, 0.7);
            --accent-blue: #3b82f6;
            --neon-glow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        body {
            /* Cyberpunk Blue/Black Gradient Background */
            background: radial-gradient(circle at top right, #1e293b, #020617);
            font-family: 'Inter', sans-serif;
            color: #f8fafc;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Glassmorphism Classes */
        .glass-panel {
            background: var(--glass-blue);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.8);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
        }

        /* Elements Branding */
        .os-header {
            border-bottom: 1px solid rgba(59, 130, 246, 0.3);
            margin-bottom: 2rem;
        }

        .layout-thermal {
            width: var(--printer-width);
            background: white;
            color: black;
            padding: 4mm;
            box-sizing: border-box;
            border: 1px dashed #ccc;
            margin: 0 auto;
        }

        .layout-modern {
            width: 120mm;
            background: white;
            color: #1a1a1a;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
        }

        .barcode {
            font-family: 'Libre Barcode 128', cursive;
            font-size: 36px;
            line-height: 1;
        }

        .dashed-line { border-top: 1px dashed black; margin: 8px 0; }
        .label { font-size: 7.5pt; text-transform: uppercase; font-weight: 600; color: #666; }
        .value { font-size: 10.5pt; font-weight: 800; }

        @media print {
            body { background: white !important; }
            .no-print { display: none !important; }
            #print-view { display: block !important; background: white !important; width: 100% !important;}
            .layout-thermal { border: none !important; width: var(--printer-width) !important; }
        }

        .page-hidden { display: none !important; }
        .page-visible { display: flex !important; }

        .btn-neon {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            box-shadow: var(--neon-glow);
            transition: all 0.3s ease;
        }

        .btn-neon:hover {
            box-shadow: 0 0 25px rgba(59, 130, 246, 0.8);
            transform: translateY(-2px);
        }

        #logs {
            font-family: 'JetBrains Mono', monospace;
            scrollbar-width: thin;
            scrollbar-color: #3b82f6 transparent;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="home-page" class="max-w-4xl mx-auto page-visible flex-col no-print gap-6">
        
        <div class="glass-panel p-8 rounded-3xl relative overflow-hidden">
            <div class="absolute -top-24 -right-24 w-64 h-64 bg-blue-600/20 blur-[100px] rounded-full"></div>
            
            <div class="os-header flex justify-between items-center pb-4">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/50">
                        <span class="font-black text-xl italic">US</span>
                    </div>
                    <div>
                        <h1 class="text-xl font-black uppercase tracking-widest text-blue-400">Fly USA OS</h1>
                        <p class="text-[10px] text-blue-300/50 font-bold uppercase tracking-tighter">Terminal v4.0.1</p>
                    </div>
                </div>
                <div class="text-right">
                    <span class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">Operator</span>
                    <div id="display-user" class="text-sm font-bold text-white uppercase tracking-wider">Guest</div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                <div class="space-y-6">
                    <div>
                        <h2 class="text-3xl font-light text-white leading-tight">Ready for <br><span class="font-bold text-blue-500">Boarding.</span></h2>
                        <p class="text-gray-400 mt-2 text-sm">Automated ticketing system for pilot departures.</p>
                    </div>
                    
                    <button onclick="goToPrintPage()" class="btn-neon w-full py-8 rounded-2xl flex flex-col items-center justify-center gap-3 active:scale-95">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12.2 2h-.4a2 2 0 0 0-2 2v1.2a2 2 0 0 1-1.2 1.8l-1.5.7a2 2 0 0 1-2.4-.7l-.8-1a2 2 0 0 0-2.8-.2l-.3.3a2 2 0 0 0-.2 2.8l1 1a2 2 0 0 1 .7 2.4l-.7 1.5a2 2 0 0 1-1.8 1.2H2.2a2 2 0 0 0-2 2v.4a2 2 0 0 0 2 2h1.2a2 2 0 0 1 1.8 1.2l.7 1.5a2 2 0 0 1-.7 2.4l-1 1a2 2 0 0 0 .2 2.8l.3.3a2 2 0 0 0 2.8-.2l.8-1a2 2 0 0 1 2.4-.7l1.5.7a2 2 0 0 1 1.2 1.8v1.2a2 2 0 0 0 2 2h.4a2 2 0 0 0 2-2v-1.2a2 2 0 0 1 1.2-1.8l1.5-.7a2 2 0 0 1 2.4.7l.8 1a2 2 0 0 0 2.8.2l.3-.3a2 2 0 0 0 2.8-.2l.8-1a2 2 0 0 1 2.4-.7l1.5.7a2 2 0 0 1 1.2 1.8V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
                        <span class="text-xl font-black tracking-[0.2em]">GENERATE TICKET</span>
                    </button>
                </div>

                <div class="glass-card p-6 rounded-2xl border-blue-500/20">
                    <div class="flex items-center gap-2 mb-4 text-blue-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                        <span class="text-xs font-bold uppercase tracking-widest">Gate Scanner</span>
                    </div>
                    <input type="text" id="scanner-input" oninput="handleScan(this.value)" onkeydown="checkInputEnter(event)" placeholder="Awaiting Input..." class="w-full bg-black/40 border border-white/10 p-4 rounded-xl font-mono text-center text-xl text-blue-100 uppercase focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all">
                    <p class="text-[10px] text-gray-500 mt-3 text-center uppercase tracking-tighter">Scan boarding pass to initiate return logic</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="glass-panel p-6 rounded-2xl">
                <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                    <h2 class="text-sm font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                        <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                        Flight Logs
                    </h2>
                    <button onclick="clearHistory()" class="text-[9px] font-bold text-gray-500 hover:text-red-400 uppercase transition-colors">Wipe Data</button>
                </div>
                <div id="logs" class="space-y-2 font-mono text-[11px] text-gray-400 overflow-y-auto max-h-32">
                    <p class="text-blue-500/50">> System boot sequence complete...</p>
                </div>
                <div class="mt-4 pt-2 border-t border-white/10 flex justify-between items-center text-[10px] font-bold text-gray-500 uppercase">
                    <span id="stored-count">0 Flights Logged</span>
                    <span id="idle-warning" class="text-orange-500 hidden animate-pulse">Auto-Hibernation Soon</span>
                </div>
            </div>

            <div id="bank-status-container" class="glass-panel p-6 rounded-2xl flex flex-col items-center justify-center text-center transition-all">
                <div id="status-icon" class="mb-2 text-blue-500">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></svg>
                </div>
                <p id="status-text" class="text-sm font-bold text-blue-100 italic">Financial Uplink Ready. <br><span class="text-blue-400">$5.00 flight credit active.</span></p>
                <div id="bank-link-wrapper" class="hidden mt-4">
                    <div class="flex items-center gap-2 text-green-400 font-black animate-pulse text-xs uppercase tracking-widest">
                        <div class="w-2 h-2 bg-green-400 rounded-full"></div>
                        Syncing Bank...
                    </div>
                </div>
            </div>
        </div>

        <button onclick="openSettings()" class="glass-card hover:bg-white/10 text-gray-400 hover:text-white py-4 rounded-2xl transition-all flex items-center justify-center gap-3 uppercase tracking-[0.3em] text-[10px] font-bold">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.1a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>
            System Core Config
        </button>
    </div>

    <div id="print-view" class="page-hidden fixed inset-0 bg-black z-[50] flex flex-col items-center justify-center p-4">
        <div class="no-print mb-8 text-center">
            <div class="inline-block px-4 py-1 rounded-full border border-blue-500 text-blue-500 text-[10px] font-black uppercase mb-2 animate-pulse">Printing in progress</div>
            <h2 class="text-2xl font-black text-white uppercase tracking-tight" id="print-title">Transmitting Ticket...</h2>
        </div>

        <div id="print-area">
            <div id="layout-view-thermal" class="layout-thermal hidden">
                <div class="flex justify-between items-center mb-4">
                    <div class="font-black text-lg italic tracking-tighter">FLY USA</div>
                    <div class="text-[8px] font-bold border border-black px-1.5 py-0.5 uppercase">Boarding Pass</div>
                </div>
                <div class="dashed-line"></div>
                <div class="mb-3">
                    <div class="label">Passenger</div>
                    <div class="value name-target">---</div>
                </div>
                <div class="flex justify-between mb-3">
                    <div>
                        <div class="label">From</div>
                        <div class="text-xl font-black from-target">---</div>
                    </div>
                    <div class="flex items-center px-1 text-lg">✈</div>
                    <div class="text-right">
                        <div class="label">To</div>
                        <div class="text-xl font-black to-target">---</div>
                    </div>
                </div>
                <div class="flex justify-between gap-2 mb-3">
                    <div class="flex-1">
                        <div class="label">Ride ID</div>
                        <div class="value flight-target text-[9pt]">US000000000</div>
                    </div>
                    <div class="text-right flex-1">
                        <div class="label">Date</div>
                        <div class="value date-target text-[9pt]">-- --- ----</div>
                    </div>
                </div>
                <div class="dashed-line"></div>
                <div class="grid grid-cols-2 gap-1 mb-2 text-center bg-gray-50 p-1.5">
                    <div><div class="label">Gate</div><div class="value gate-target">--</div></div>
                    <div class="border-l border-gray-200"><div class="label">Bike</div><div class="value seat-target">--</div></div>
                </div>
                <div class="grid grid-cols-2 gap-1 mb-5 text-center bg-gray-50 p-1.5 pt-0">
                    <div><div class="label">Real Time</div><div class="value time-target">--:--</div></div>
                    <div class="border-l border-gray-200"><div class="label">Bank Time</div><div class="value bank-time-target">--:-- --</div></div>
                </div>
                <div class="flex flex-col items-center gap-3">
                    <div class="qr-target bg-white p-1"></div>
                    <div class="barcode text-center barcode-target">US000000000</div>
                </div>
            </div>

            <div id="layout-view-modern" class="layout-modern hidden">
                <div class="bg-blue-600 p-4 text-white flex justify-between items-center">
                    <div>
                        <div class="text-xs opacity-80 uppercase font-bold tracking-widest">Official Boarding Pass</div>
                        <div class="text-2xl font-black italic">FLY USA</div>
                    </div>
                    <div class="text-right">
                        <div class="text-xs opacity-80 uppercase font-bold">Ride No.</div>
                        <div class="text-xl font-bold flight-target">US000</div>
                    </div>
                </div>
                <div class="p-6 grid grid-cols-2 gap-6">
                    <div>
                        <div class="mb-4">
                            <div class="label">Passenger Name</div>
                            <div class="text-lg font-bold name-target">---</div>
                        </div>
                        <div class="flex justify-between items-end bg-gray-50 p-3 rounded-lg border border-gray-100">
                            <div>
                                <div class="label">Origin</div>
                                <div class="text-2xl font-black text-blue-600 from-target">---</div>
                            </div>
                            <div class="pb-1 text-gray-300">→</div>
                            <div class="text-right">
                                <div class="label">Destination</div>
                                <div class="text-2xl font-black text-blue-600 to-target">---</div>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col items-center justify-center border-l border-gray-100 pl-6">
                        <div class="qr-target mb-2"></div>
                        <div class="text-[7pt] font-mono barcode-target">US000</div>
                    </div>
                </div>
                <div class="bg-gray-100 p-4 grid grid-cols-5 gap-2 text-center border-t border-gray-200">
                    <div><div class="label">Gate</div><div class="font-bold gate-target text-xs">--</div></div>
                    <div><div class="label">Seat</div><div class="font-bold seat-target text-xs">--</div></div>
                    <div><div class="label">Time</div><div class="font-bold time-target text-xs">--:--</div></div>
                    <div><div class="label">Bank</div><div class="font-bold bank-time-target text-xs">--:--</div></div>
                    <div><div class="label">Date</div><div class="font-bold date-target text-[10px]">--/--</div></div>
                </div>
            </div>
        </div>

        <button onclick="goHome()" class="no-print mt-10 text-gray-500 font-bold hover:text-white transition-colors uppercase tracking-[0.5em] text-[10px]">
            Abort Sequence
        </button>
    </div>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-[100] px-4 backdrop-blur-md">
        <div class="glass-panel p-8 rounded-3xl max-w-lg w-full shadow-2xl overflow-y-auto max-h-[90vh] border-blue-500/30">
            <h3 class="text-2xl font-black mb-6 text-white uppercase tracking-tight">System Configuration</h3>
            
            <div class="mb-6">
                <label class="block text-[10px] font-bold text-blue-400 mb-2 uppercase tracking-[0.2em]">Output Mode</label>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="setLayout('thermal')" id="btn-layout-thermal" class="py-4 border border-white/10 rounded-xl font-bold transition-all text-sm uppercase">Thermal</button>
                    <button onclick="setLayout('modern')" id="btn-layout-modern" class="py-4 border border-white/10 rounded-xl font-bold transition-all text-sm uppercase">Modern</button>
                </div>
            </div>

            <div id="thermal-width-setting" class="mb-6 hidden">
                <label class="block text-[10px] font-bold text-blue-400 mb-2 uppercase tracking-[0.2em]">Printer Width Control</label>
                <div class="flex items-center gap-4 bg-white/5 p-4 rounded-xl border border-white/5">
                    <input type="range" id="width-range" min="40" max="120" step="1" class="flex-1 accent-blue-500" oninput="updateWidthDisplay(this.value)">
                    <span id="width-value" class="font-mono font-bold text-blue-400 w-16 text-right">75mm</span>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-[10px] font-bold text-blue-400 mb-2 uppercase tracking-[0.2em]">Node Directory (Locations)</label>
                <textarea id="airport-list" rows="4" class="w-full bg-black/40 border border-white/10 p-4 rounded-xl font-mono text-blue-100 text-xs uppercase focus:border-blue-500 outline-none" placeholder="HOME, PARK, SHOP..."></textarea>
            </div>
            
            <div class="flex gap-3">
                <button onclick="saveSettings()" class="flex-1 btn-neon text-white py-4 rounded-xl font-black text-xs uppercase tracking-widest">Commit Changes</button>
                <button onclick="closeSettings()" class="bg-white/5 px-6 py-4 rounded-xl font-bold text-gray-400 hover:text-white uppercase text-[10px]">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // ... (The Logic script remains identical to your provided code to ensure functionality)
        function getActiveUser() {
            const urlParams = new URLSearchParams(window.location.search);
            let user = urlParams.get('user');
            if (!user) user = localStorage.getItem('active_directory_user') || 'guest';
            return user.toLowerCase();
        }

        const activeUser = getActiveUser();
        const defaultAirports = ["HOME", "PARK", "SHOP", "SCHOOL", "TRAIL", "HILL", "LAKE", "BRIDGE", "CENTER"];
        const names = ["Alex River", "Jamie Smith", "Casey Lane", "Taylor Reed", "Morgan Hill", "Jordan West", "Skyler Blue", "Riley Quinn", "Peyton Ross", "Charlie Day"];

        let currentLayout = localStorage.getItem('flyusa_layout') || 'thermal';
        let currentWidth = localStorage.getItem('flyusa_width') || '75';
        let qrInstances = [];
        let idleTimer;
        const IDLE_TIME_LIMIT = 15000;
        const REDIRECT_URL = "https://rubiks13.github.io/bikes/";
        const BANK_BASE_URL = "https://rubiks13.github.io/bank/";

        function resetIdleTimer() {
            clearTimeout(idleTimer);
            const warningEl = document.getElementById('idle-warning');
            if (warningEl) warningEl.classList.add('hidden');
            
            idleTimer = setTimeout(() => {
                const isPrinting = !document.getElementById('print-view').classList.contains('page-hidden');
                const isSettingsOpen = !document.getElementById('settings-modal').classList.contains('hidden');
                const isBankActive = !document.getElementById('bank-link-wrapper').classList.contains('hidden');
                if (!isPrinting && !isSettingsOpen && !isBankActive) { 
                    window.location.href = REDIRECT_URL; 
                } else { 
                    resetIdleTimer(); 
                }
            }, IDLE_TIME_LIMIT);

            setTimeout(() => {
               const isPrinting = !document.getElementById('print-view').classList.contains('page-hidden');
               const isBankActive = !document.getElementById('bank-link-wrapper').classList.contains('hidden');
               if (window.location.href !== REDIRECT_URL && !isPrinting && !isBankActive) { 
                   if (warningEl) warningEl.classList.remove('hidden'); 
               }
            }, IDLE_TIME_LIMIT - 3000);
        }

        window.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                openSettings();
            }
            resetIdleTimer();
        });

        window.addEventListener('mousemove', resetIdleTimer);
        window.addEventListener('touchstart', resetIdleTimer);

        function updateWidthDisplay(val) {
            document.getElementById('width-value').textContent = val + 'mm';
            document.documentElement.style.setProperty('--printer-width', val + 'mm');
            currentWidth = val;
        }

        function getBankTime() {
            let startTime = localStorage.getItem('sim_bank_start_real_time');
            if (!startTime) { 
                startTime = Date.now(); 
                localStorage.setItem('sim_bank_start_real_time', startTime); 
            }
            const elapsedMins = (Date.now() - startTime) / 60000;
            const bankHour = Math.floor(elapsedMins % 24);
            const bankMinute = Math.floor((elapsedMins * 60) % 60);
            const ampm = bankHour >= 12 ? 'PM' : 'AM';
            const displayHour = bankHour % 12 || 12;
            const displayMin = bankMinute.toString().padStart(2, '0');
            return `${displayHour}:${displayMin} ${ampm}`;
        }

        function initQRs() {
            document.querySelectorAll('.qr-target').forEach((el) => { 
                qrInstances.push(new QRCode(el, { width: 90, height: 90 })); 
            });
        }

        function getFlightDb() {
            const db = localStorage.getItem(`flyusa_flights_${activeUser}`);
            return db ? JSON.parse(db) : {};
        }

        function saveFlightToDb(data) {
            const db = getFlightDb();
            db[data.flight] = data;
            localStorage.setItem(`flyusa_flights_${activeUser}`, JSON.stringify(db));
            updateLogDisplay();
        }

        function handleJobCompletion(data) {
            const currentBankTime = getBankTime();
            document.querySelectorAll('.bank-time-target').forEach(el => el.textContent = currentBankTime);

            window.print();
            
            setTimeout(() => {
                const amount = 5.00;
                const paymentUrl = `${BANK_BASE_URL}?user=${encodeURIComponent(activeUser)}&amount=${amount.toFixed(2)}`;
                
                const bankWrapper = document.getElementById('bank-link-wrapper');
                const statusTxt = document.getElementById('status-text');
                const container = document.getElementById('bank-status-container');

                statusTxt.textContent = "UPLINK SUCCESSFUL. SENDING $" + amount.toFixed(2);
                bankWrapper.classList.remove('hidden');
                container.style.borderColor = "#22c55e";

                setTimeout(() => { window.location.href = paymentUrl; }, 2000); 
                goHome();
            }, 1000);
        }

        function updateLogDisplay() {
            const db = getFlightDb();
            document.getElementById('stored-count').textContent = `${Object.keys(db).length} FLIGHTS CACHED`;
            const logs = document.getElementById('logs');
            logs.innerHTML = '';
            Object.keys(db).slice(-10).reverse().forEach(id => {
                const p = document.createElement('p');
                p.textContent = `> [${id}] ${db[id].from} >> ${db[id].to}`;
                logs.appendChild(p);
            });
            if (Object.keys(db).length === 0) logs.innerHTML = '<p>> NO ACTIVE LOGS DETECTED</p>';
        }

        function clearHistory() {
            if(confirm("Format system logs?")) {
                localStorage.removeItem(`flyusa_flights_${activeUser}`);
                updateLogDisplay();
            }
        }

        function handleScan(value) {
            const db = getFlightDb();
            const cleanVal = value.trim().toUpperCase();
            if (db[cleanVal]) {
                const nextRide = generateRandomRide(db[cleanVal].to, null, db[cleanVal].from, db[cleanVal].name);
                const currentDb = getFlightDb();
                delete currentDb[cleanVal];
                localStorage.setItem(`flyusa_flights_${activeUser}`, JSON.stringify(currentDb));
                document.getElementById('scanner-input').value = '';
                populateTicket(nextRide);
                executePrintSequence(nextRide);
            }
        }

        function checkInputEnter(event) { 
            if (event.key === "Enter" && event.target.value.trim() === "") goToPrintPage(); 
        }

        function goToPrintPage() {
            const data = generateRandomRide();
            populateTicket(data);
            executePrintSequence(data);
        }

        function executePrintSequence(data) {
            document.getElementById('bank-link-wrapper').classList.add('hidden');
            document.getElementById('status-text').textContent = "Compiling data for print...";
            
            saveFlightToDb(data);
            document.getElementById('home-page').classList.replace('page-visible', 'page-hidden');
            document.getElementById('print-view').classList.replace('page-hidden', 'page-visible');
            document.getElementById('layout-view-thermal').classList.add('hidden');
            document.getElementById('layout-view-modern').classList.add('hidden');
            
            if (currentLayout === 'thermal') {
                document.getElementById('layout-view-thermal').classList.remove('hidden');
            } else {
                document.getElementById('layout-view-modern').classList.remove('hidden');
            }
            
            setTimeout(() => { handleJobCompletion(data); }, 500);
        }

        function goHome() {
            document.getElementById('print-view').classList.replace('page-visible', 'page-hidden');
            document.getElementById('home-page').classList.replace('page-hidden', 'page-visible');
            setTimeout(() => { 
                const input = document.getElementById('scanner-input');
                if (input) input.focus(); 
            }, 100);
            resetIdleTimer();
        }

        function generateRandomRide(customFrom = null, customName = null, restrictedTo = null, restrictedName = null) {
            const pool = getAirports();
            let from = customFrom || pool[Math.floor(Math.random() * pool.length)];
            let to; 
            do { to = pool[Math.floor(Math.random() * pool.length)]; } while (to === from || (restrictedTo && to === restrictedTo));
            
            let selectedName = customName || names[Math.floor(Math.random() * names.length)].toUpperCase();
            const now = new Date();
            return {
                name: selectedName,
                flight: "US" + Math.floor(100000000 + Math.random() * 900000000),
                from, to,
                gate: String.fromCharCode(65 + Math.floor(Math.random() * 4)) + Math.floor(Math.random() * 9 + 1),
                seat: (Math.floor(Math.random() * 12) + 1) + "B",
                time: String(now.getHours()).padStart(2, '0') + ":" + String(now.getMinutes()).padStart(2, '0'),
                date: now.toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }).toUpperCase()
            };
        }

        function populateTicket(data) {
            document.querySelectorAll('.name-target').forEach(el => el.textContent = data.name);
            document.querySelectorAll('.from-target').forEach(el => el.textContent = data.from);
            document.querySelectorAll('.to-target').forEach(el => el.textContent = data.to);
            document.querySelectorAll('.flight-target').forEach(el => el.textContent = data.flight);
            document.querySelectorAll('.date-target').forEach(el => el.textContent = data.date);
            document.querySelectorAll('.gate-target').forEach(el => el.textContent = data.gate);
            document.querySelectorAll('.seat-target').forEach(el => el.textContent = data.seat);
            document.querySelectorAll('.time-target').forEach(el => el.textContent = data.time);
            document.querySelectorAll('.barcode-target').forEach(el => el.textContent = data.flight);
            qrInstances.forEach(inst => { inst.clear(); inst.makeCode(data.flight); });
        }

        function setLayout(type) {
            currentLayout = type;
            const btnT = document.getElementById('btn-layout-thermal');
            const btnM = document.getElementById('btn-layout-modern');
            
            if(type === 'thermal') {
                btnT.style.borderColor = '#3b82f6'; btnT.style.color = '#3b82f6';
                btnM.style.borderColor = 'rgba(255,255,255,0.1)'; btnM.style.color = '#6b7280';
            } else {
                btnM.style.borderColor = '#3b82f6'; btnM.style.color = '#3b82f6';
                btnT.style.borderColor = 'rgba(255,255,255,0.1)'; btnT.style.color = '#6b7280';
            }
            document.getElementById('thermal-width-setting').classList.toggle('hidden', type !== 'thermal');
        }

        function openSettings() {
            document.getElementById('airport-list').value = localStorage.getItem('flyusa_airports') || defaultAirports.join(", ");
            const savedWidth = localStorage.getItem('flyusa_width') || '75';
            document.getElementById('width-range').value = savedWidth;
            updateWidthDisplay(savedWidth);
            setLayout(currentLayout);
            document.getElementById('settings-modal').classList.remove('hidden');
        }

        function closeSettings() { 
            document.getElementById('settings-modal').classList.add('hidden'); 
            resetIdleTimer(); 
        }

        function saveSettings() {
            localStorage.setItem('flyusa_airports', document.getElementById('airport-list').value);
            localStorage.setItem('flyusa_layout', currentLayout);
            localStorage.setItem('flyusa_width', currentWidth);
            closeSettings();
        }

        function getAirports() {
            const stored = localStorage.getItem('flyusa_airports');
            return stored ? stored.split(',').map(s => s.trim().toUpperCase()).filter(s => s.length > 0) : defaultAirports;
        }

        window.onload = () => {
            const userDisplay = document.getElementById('display-user');
            if (userDisplay) userDisplay.textContent = activeUser;
            const savedWidth = localStorage.getItem('flyusa_width') || '75';
            updateWidthDisplay(savedWidth);
            initQRs();
            updateLogDisplay();
            const input = document.getElementById('scanner-input');
            if (input) input.focus();
            resetIdleTimer();
        };
    </script>
</body>
</html>
